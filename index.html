<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeakUp AI - AI 영어 회화 튜터</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f7fafc; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-glow-blue { box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .btn-glow-amber { box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }
        .btn-glow-teal { box-shadow: 0 0 15px rgba(20, 184, 166, 0.4); }
        .btn-glow-indigo { box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }

        .gradient-bg { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
        .header-bg { background-color: #2c5282; }
        .chat-bg { background-color: #f8fafc; }
        .user-bubble { background-color: #3b82f6; }
        .ai-bubble { background-color: #e5e7eb; }
        .input-area-bg { background-color: #ffffff; }
        .modal-bg-overlay { background-color: rgba(0, 0, 0, 0.6); }
        .scenario-picker-item:hover { background-color: #eff6ff; }
        .scenario-picker-item-selected { background-color: #dbeafe; font-weight: 600; color: #1d4ed8; }
        .category-header:hover { background-color: #f0f9ff; }
        .ai-bubble ul { list-style-type: disc; padding-left: 20px; margin-top: 8px; margin-bottom: 8px; }
        .ai-bubble li { margin-bottom: 4px; }
        .compact-button {
            padding-top: 0.5rem; 
            padding-bottom: 0.5rem; 
            padding-left: 0.5rem; 
            padding-right: 0.5rem; 
            font-size: 0.8rem; 
            line-height: 1.1rem;
            min-height: 38px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            text-align: center;
        }
        .compact-button svg {
            margin-right: 0.25rem;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen gradient-bg p-2 sm:p-4">

    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col" style="height: calc(100vh - 30px); max-height: 800px;">
        <header class="header-bg text-white p-4 sm:p-5 rounded-t-2xl flex items-center justify-between relative shadow-md">
            <div class="flex items-center">
                <div class="relative" id="scenarioPickerContainer">
                    <button id="scenarioPickerButton" class="flex items-center text-sm sm:text-base bg-sky-700 hover:bg-sky-600 px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-400">
                        <span id="currentScenarioDisplay">시나리오</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 ml-1.5 opacity-80"> <path fillRule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clipRule="evenodd" /> </svg>
                    </button>
                    <div id="scenarioDropdown" class="hidden absolute left-0 mt-2 w-72 sm:w-80 bg-white rounded-lg shadow-xl z-20 border border-slate-200 max-h-96 overflow-y-auto custom-scrollbar fade-in">
                        </div>
                </div>
            </div>
            <h1 id="headerTitle" class="text-xl sm:text-2xl font-semibold text-center absolute left-1/2 transform -translate-x-1/2 truncate max-w-[45%] sm:max-w-[55%]" title="SpeakUp AI">SpeakUp AI</h1> 
            <button id="newConversationButton" title="새 대화 시작" class="text-sm sm:text-base bg-sky-700 hover:bg-sky-600 p-2 sm:p-2.5 rounded-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-400">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-5 h-5"> <path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /> </svg>
            </button>
        </header>

        <div id="scenarioDescriptionArea" class="p-4 sm:p-5 border-b border-slate-200 bg-slate-50">
            <h2 id="scenarioTitle" class="text-lg sm:text-xl font-semibold text-sky-700 mb-1.5">시나리오 제목</h2>
            <p id="scenarioDescription" class="text-sm text-slate-600 mb-3 leading-relaxed hide-after-conversation-start">시나리오 설명</p>
            <div id="starterPhrasesContainer" class="mt-2 mb-3 hidden hide-after-conversation-start">
                <p class="text-xs font-semibold text-sky-600 mb-1.5">이렇게 시작해 보세요:</p>
                <div id="starterPhrases" class="flex flex-wrap gap-2">
                    </div>
            </div>
            <div id="focusTopicGroup" class="hide-after-conversation-start">
                 <input type="text" id="focusTopicInput" placeholder="집중 연습 주제 (선택 사항)" class="w-full p-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow"/>
            </div>
            <div id="customScenarioGroup" class="hidden hide-after-conversation-start">
                <textarea id="customScenarioInput" placeholder="연습하고 싶은 상황이나 대화 주제를 자세히 입력해주세요..." class="w-full p-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow" rows="3"></textarea>
            </div>
        </div>

        <div id="messagesContainer" class="flex-grow p-4 sm:p-5 overflow-y-auto chat-bg space-y-4 custom-scrollbar">
            </div>
        
        <div class="p-4 sm:p-5 border-t border-slate-200 input-area-bg">
            <div class="flex items-center space-x-3 mb-3"> 
                <input type="text" id="userInput" placeholder="메시지를 입력하세요..." class="flex-grow p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow text-base shadow-sm"/>
                <button id="sendMessageButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-xl transition-all duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center shadow-md hover:shadow-lg btn-glow-blue focus:outline-none focus:ring-2 focus:ring-blue-300">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"> <path d="M3.5 2.75a.75.75 0 00-1.061.645l1.906 11.438a.75.75 0 001.412-.001L7.25 9.086l5.438-4.078a.75.75 0 00-.816-1.299L4.06 7.354 3.5 2.75zM2.75 16.5a.75.75 0 001.061.645l12.626-7.575a.75.75 0 000-1.29l-12.626-7.575A.75.75 0 002.75 1.5v15z" /> </svg>
                </button>
            </div>
            
            <div id="suggestedRepliesContainer" class="mb-2.5 p-2.5 bg-sky-50 rounded-lg hidden shadow fade-in">
                <h4 class="text-xs font-semibold text-sky-700 mb-1.5">AI 응답 제안:</h4>
                <ul id="suggestedRepliesList" class="space-y-1.5">
                    </ul>
            </div>

            <div class="flex space-x-2"> 
                <button id="suggestRepliesButton" class="compact-button bg-amber-400 hover:bg-amber-500 text-amber-900 font-semibold rounded-lg transition-all duration-150 ease-in-out disabled:opacity-60 flex items-center justify-center shadow hover:shadow-md btn-secondary-glow focus:outline-none focus:ring-2 focus:ring-amber-300 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"> <path fillRule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.39-3.423 3.352c-.772.753-.235 2.047.788 2.225l4.21.728 1.948 4.24c.322.772 1.416.772 1.737 0l1.947-4.24 4.21-.728c1.023-.178 1.56-1.472.788-2.225l-3.423-3.352-4.753-.39-1.83-4.401zM12.267 8.197L10 12.488l-2.267-4.291-4.573-.374 3.29-3.218-1.043-4.493 4.065 1.956L10 0l2.528 1.978 4.065-1.956-1.043 4.493 3.29 3.218-4.573.374z" clipRule="evenodd" /> </svg> 
                    <span id="suggestRepliesButtonText">응답 제안</span>
                </button>
                <button id="analyzeSentenceButton" class="compact-button bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded-lg transition-all duration-150 ease-in-out disabled:opacity-60 flex items-center justify-center shadow-md hover:shadow-lg btn-tertiary-glow focus:outline-none focus:ring-2 focus:ring-teal-300 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"> <path fillRule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.39-3.423 3.352c-.772.753-.235 2.047.788 2.225l4.21.728 1.948 4.24c.322.772 1.416.772 1.737 0l1.947-4.24 4.21-.728c1.023-.178 1.56-1.472.788-2.225l-3.423-3.352-4.753-.39-1.83-4.401zM12.267 8.197L10 12.488l-2.267-4.291-4.573-.374 3.29-3.218-1.043-4.493 4.065 1.956L10 0l2.528 1.978 4.065-1.956-1.043 4.493 3.29 3.218-4.573.374z" clipRule="evenodd" /> </svg> 
                    <span id="analyzeSentenceButtonText">문장 분석</span>
                </button>
                <button id="roleSwapButton" class="compact-button bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg transition-all duration-150 ease-in-out disabled:opacity-60 flex items-center justify-center shadow-md hover:shadow-lg btn-glow-indigo focus:outline-none focus:ring-2 focus:ring-indigo-300 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                    </svg>
                    <span id="roleSwapButtonText">역할 변경</span>
                </button>
            </div>
        </div>
    </div>

    <div id="analysisModal" class="hidden fixed inset-0 modal-bg-overlay flex items-center justify-center p-4 z-50 fade-in">
        <div id="analysisModalContent" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl sm:text-2xl font-semibold text-sky-700">✨ 내 문장 분석 결과</h3>
                <button id="closeAnalysisModalButton" class="text-slate-400 hover:text-slate-600 text-3xl transition-colors">&times;</button>
            </div>
            <div id="englishAnalysisResult" class="mb-5">
                <h4 class="text-lg font-medium text-slate-800 mb-1.5">📝 영어 피드백:</h4>
                <div class="text-base text-slate-700 whitespace-pre-wrap leading-relaxed p-3 bg-slate-50 rounded-md border border-slate-200"></div>
            </div>
            <div id="koreanAnalysisResult">
                <h4 class="text-lg font-medium text-slate-800 mb-1.5">🇰🇷 한국어 요약:</h4>
                <div class="text-base text-slate-700 whitespace-pre-wrap leading-relaxed p-3 bg-sky-50 rounded-md border border-sky-200"></div>
            </div>
            <button id="confirmAnalysisModalButton" class="mt-6 w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-sky-400">
                확인했어요!
            </button>
        </div>
    </div>

    <script type="module">
        // Firebase SDK 가져오기
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => { 
            // --- DOM 요소 가져오기 ---
            const scenarioPickerButton = document.getElementById('scenarioPickerButton');
            const currentScenarioDisplay = document.getElementById('currentScenarioDisplay');
            const scenarioDropdown = document.getElementById('scenarioDropdown');
            const headerTitle = document.getElementById('headerTitle'); 
            const newConversationButton = document.getElementById('newConversationButton');
            
            const scenarioDescriptionArea = document.getElementById('scenarioDescriptionArea');
            const scenarioTitleElem = document.getElementById('scenarioTitle');
            const scenarioDescriptionElem = document.getElementById('scenarioDescription');
            const starterPhrasesContainer = document.getElementById('starterPhrasesContainer');
            const starterPhrasesElem = document.getElementById('starterPhrases');
            const focusTopicGroup = document.getElementById('focusTopicGroup');
            const focusTopicInput = document.getElementById('focusTopicInput');
            const customScenarioGroup = document.getElementById('customScenarioGroup');
            const customScenarioInputElem = document.getElementById('customScenarioInput');

            const messagesContainer = document.getElementById('messagesContainer');
            const userInputElem = document.getElementById('userInput'); 
            const sendMessageButton = document.getElementById('sendMessageButton');

            const suggestedRepliesContainer = document.getElementById('suggestedRepliesContainer');
            const suggestedRepliesList = document.getElementById('suggestedRepliesList');
            const suggestRepliesButton = document.getElementById('suggestRepliesButton');
            const suggestRepliesButtonText = document.getElementById('suggestRepliesButtonText');
            
            const analyzeSentenceButton = document.getElementById('analyzeSentenceButton');
            const analyzeSentenceButtonText = document.getElementById('analyzeSentenceButtonText');
            const analysisModal = document.getElementById('analysisModal');
            const analysisModalContent = document.getElementById('analysisModalContent');
            const englishAnalysisResultDiv = document.querySelector('#englishAnalysisResult div');
            const koreanAnalysisResultDiv = document.querySelector('#koreanAnalysisResult div');
            const closeAnalysisModalButton = document.getElementById('closeAnalysisModalButton');
            const confirmAnalysisModalButton = document.getElementById('confirmAnalysisModalButton');
            
            const roleSwapButton = document.getElementById('roleSwapButton');

            // --- 상태 변수 ---
            let currentMessages = [];
            let currentScenario; 
            let currentFocusTopic = '';
            let currentCustomScenarioInput = '';
            let isLoading = false;
            let isLoadingSuggestions = false;
            let isLoadingAnalysis = false;
            let showScenarioPicker = false;
            let expandedCategories = {}; 
            let db, auth, currentUserId, isAuthReady = false;
            let userIsPlayingPrimaryRole = true; 

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'ai-tutor-html-default-v1';

            // --- Firebase 설정 ---
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                apiKey: "YOUR_API_KEY", 
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

            // --- 시나리오 데이터 ---
            const scenarioTree = [ /* 이전과 동일 (병원, 치과 시나리오 추가됨) */ 
                { category: "일상 생활 (Everyday Life)", items: [ { id: "cafe", title: "카페에서 주문하기 ☕", description: "바리스타에게 커피를 주문하고 간단한 요청을 해보세요.", baseContext: "You are a friendly barista. The user is ordering coffee and might ask for recommendations or make small talk. Help them practice their English for this situation.", baseContext_swapped: "You are a customer ordering coffee at a cafe. The user is playing the role of the barista. Make your order, ask questions, or make small talk.", starters: ["Hi, can I get a latte?", "Hello! What do you recommend?", "I'd like to order a coffee, please."] }, { id: "grocery_shopping", title: "식료품점에서 장보기 🛒", description: "점원에게 물건 위치를 묻거나 계산할 때 대화해보세요.", baseContext: "You are a helpful grocery store clerk. The user is shopping and might ask for item locations, prices, or help at checkout. Assist them with their English.", baseContext_swapped:"You are a customer at a grocery store. The user is the store clerk. Ask for items, prices, or help.", starters: ["Excuse me, where can I find the milk?", "How much is this?", "I'd like to pay for these items."] }, { id: "making_appointments", title: "예약하기 (미용실, 병원 등) 🗓️", description: "전화나 방문을 통해 예약하는 상황을 연습합니다.", baseContext: "You are a receptionist at a salon/clinic. The user wants to make an appointment. Guide them through scheduling, asking for preferences, and confirming details.", baseContext_swapped:"You want to make an appointment at a salon or clinic. The user is the receptionist. State your needs and schedule an appointment.", starters: ["I'd like to make an appointment for a haircut.", "Do you have any openings next Tuesday?", "Can I book a check-up for this week?"] }, { id: "daily_routine_talk", title: "일상 이야기하기 ☀️", description: "하루 일과나 주말 계획 등 일상적인 주제로 대화합니다.", baseContext: "You are a friend or acquaintance. The user wants to talk about their daily routine, weekend plans, or general everyday topics. Engage in a casual conversation.", baseContext_swapped:"You are talking to a friend or acquaintance (the user). Discuss your daily routine, weekend plans, or general topics.", starters: ["How was your day?", "What are you up to this weekend?", "I usually [activity] in the morning."] }, { id: "public_transportation", title: "대중교통 이용하기 🚌", description: "버스나 지하철 표를 사거나 길을 묻는 상황입니다.", baseContext: "You are a public transport staff or a helpful passenger. The user needs help with buying a ticket, finding the right bus/train, or understanding the route. Provide clear assistance.", baseContext_swapped:"You need help using public transport. The user is a staff member or helpful passenger. Ask for directions or ticket information.", starters: ["Which bus goes to downtown?", "How much is a single ride ticket?", "Is this the platform for the express train?"] } ] }, 
                { category: "여행 (Travel)", items: [ { id: "airport_checkin", title: "공항 체크인 ✈️", description: "공항 체크인 카운터에서 탑승 수속을 진행합니다.", baseContext: "You are an airline check-in agent. The user is checking in for a flight. Ask for passport/ticket, discuss baggage, seat preferences.", baseContext_swapped:"You are at the airport checking in for your flight. The user is the check-in agent. Provide your documents and discuss your flight details.", starters: ["I'd like to check in for my flight to London.", "Here's my passport and ticket.", "Can I have a window seat, please?"] }, { id: "hotel_checkin", title: "호텔 체크인 🏨", description: "호텔 프론트에서 예약 확인 및 체크인을 합니다.", baseContext: "You are a hotel receptionist. The user is checking in. Confirm reservation, explain amenities, answer questions.", baseContext_swapped:"You are checking into a hotel. The user is the receptionist. Provide your reservation details and ask any necessary questions.", starters: ["I have a reservation under the name [Your Name].", "Could you tell me what time breakfast is served?", "Is there Wi-Fi in the room?"] }, { id: "asking_directions", title: "길 묻기 🗺️", description: "여행 중 모르는 곳에서 길을 묻는 상황입니다.", baseContext: "You are a local resident. The user is a tourist asking for directions. Provide clear instructions and be helpful.", baseContext_swapped:"You are a tourist asking for directions. The user is a local resident. Ask for help finding your way.", starters: ["Excuse me, how can I get to the museum?", "Could you show me on the map?", "Is this the right way to the train station?"] }, { id: "ordering_at_restaurant_travel", title: "여행 중 식당 주문 🍽️", description: "여행지 식당에서 음식을 주문하고 현지 음식에 대해 질문합니다.", baseContext: "You are a waiter/waitress in a tourist-friendly restaurant. The user is ordering food and might ask about local specialties. Be patient and helpful.", baseContext_swapped:"You are a customer at a restaurant in a tourist area. The user is the waiter/waitress. Order food and ask about the menu.", starters: ["What's the local specialty here?", "I'd like to try something traditional.", "Can you recommend a dish?"] }, { id: "booking_tour", title: "여행 상품 예약하기 🏞️", description: "현지 투어나 액티비티를 예약하는 상황입니다.", baseContext: "You are a travel agent or tour operator. The user wants to book a tour or activity. Provide information about options, prices, and make the booking.", baseContext_swapped:"You want to book a local tour or activity. The user is the travel agent. Inquire about options and make a booking.", starters: ["I'm interested in booking a city tour.", "What kind of tours do you offer?", "How much does the [tour name] cost?"] }, { id: "at_immigration", title: "입국 심사대에서 🛂", description: "공항 입국 심사대에서 심사관의 질문에 답변합니다.", baseContext: "You are an immigration officer. The user is arriving in the country. Ask about the purpose of their visit, length of stay, and check their documents.", baseContext_swapped:"You are at immigration control upon arriving in a new country. The user is the immigration officer. Answer their questions about your visit.", starters: ["Good morning. May I see your passport?", "What is the purpose of your visit?", "How long do you plan to stay?"] } ] }, 
                { category: "직장 생활 (Work & Business)", items: [ { id: "job_interview", title: "면접 보기 💼", description: "구직 면접 상황을 연습합니다. 자기소개, 질문 답변 등", baseContext: "You are an interviewer for a job position. The user is a candidate. Ask common interview questions and evaluate their responses in English.", baseContext_swapped:"You are a candidate at a job interview. The user is the interviewer. Answer questions about your qualifications and experience.", starters: ["Tell me about yourself.", "Why are you interested in this position?", "What are your strengths?"] }, { id: "meeting_colleagues", title: "동료와 회의하기 👥", description: "업무 관련 회의에서 의견을 제시하고 토론합니다.", baseContext: "You are a colleague in a business meeting. The user is participating in the meeting. Discuss agenda items, share opinions, and collaborate.", baseContext_swapped:"You are participating in a business meeting with colleagues. The user is one of your colleagues. Share your opinions and discuss agenda items.", starters: ["I'd like to suggest an idea.", "What are your thoughts on this proposal?", "Let's discuss the next steps."] }, { id: "phone_call_business", title: "업무 전화 통화 📞", description: "비즈니스 목적으로 전화를 걸거나 받는 상황입니다.", baseContext: "You are a business professional on a phone call. The user is either initiating or receiving a business call. Handle inquiries, schedule meetings, or discuss projects professionally.", baseContext_swapped:"You are making or receiving a business phone call. The user is the other party. Discuss professional matters, schedule appointments, or make inquiries.", starters: ["Hello, this is [Your Name] from [Your Company].", "May I speak to Mr./Ms. [Name]?", "I'm calling to inquire about..."] }, { id: "presentation_qna", title: "발표 후 질의응답 🎤", description: "발표를 마친 후 청중의 질문에 답변하는 상황입니다.", baseContext: "You are an audience member after a presentation. The user is the presenter. Ask relevant questions about their presentation.", baseContext_swapped:"You are the presenter who has just finished a presentation. The user is an audience member asking questions. Answer their questions clearly.", starters: ["Thank you for your presentation. I have a question about...", "Could you elaborate on [specific point]?", "What are the implications of your findings?"] }, { id: "networking_event", title: "네트워킹 행사 🤝", description: "업계 행사에서 새로운 사람들과 교류하며 대화합니다.", baseContext: "You are attending a networking event. The user is also an attendee. Initiate or respond to conversations to build professional connections.", baseContext_swapped:"You are attending a networking event. The user is another attendee. Engage in conversation to build professional connections.", starters: ["Hi, I'm [Your Name]. What brings you to this event?", "That's an interesting point. Could you tell me more?", "It was nice talking to you. Here's my card."] } ] }, 
                { category: "취미 및 관심사 (Hobbies & Interests)", items: [ { id: "discussing_movie", title: "영화 이야기하기 🎬", description: "최근에 본 영화나 좋아하는 영화에 대해 친구와 이야기합니다.", baseContext: "You are a friend discussing movies with the user. Talk about recent movies, favorite genres, actors, etc. Encourage the user to express their opinions in English.", baseContext_swapped:"You are discussing movies with a friend (the user). Share your opinions about movies, genres, actors, etc.", starters: ["Have you seen any good movies lately?", "What's your favorite type of movie?", "I recently watched [Movie Title]..."] }, { id: "talking_about_music", title: "음악 취향 공유하기 🎶", description: "좋아하는 음악 장르, 가수, 노래에 대해 이야기 나눕니다.", baseContext: "You are a friend talking about music. Discuss favorite genres, artists, songs, concerts, etc. Help the user share their musical tastes in English.", baseContext_swapped:"You are talking about music with a friend (the user). Share your musical tastes, favorite artists, songs, etc.", starters: ["What kind of music do you like?", "Who's your favorite singer?", "Have you heard the new song by [Artist]?"] }, { id: "discussing_books", title: "책에 대해 대화하기 📚", description: "읽은 책이나 좋아하는 작가, 장르에 대해 이야기합니다.", baseContext: "You are a fellow book lover. The user wants to discuss books they've read, favorite authors, or genres. Share your thoughts and ask them about theirs.", baseContext_swapped:"You are discussing books with a fellow book lover (the user). Talk about books you've read, favorite authors, or genres.", starters: ["What are you reading currently?", "Do you have a favorite author?", "I just finished a great book called..."] }, { id: "talking_about_sports", title: "스포츠 이야기하기 ⚽", description: "좋아하는 스포츠, 팀, 선수에 대해 이야기합니다.", baseContext: "You are a sports enthusiast. The user wants to talk about sports. Discuss favorite sports, teams, players, recent games, etc.", baseContext_swapped:"You are talking about sports with an enthusiast (the user). Discuss your favorite sports, teams, players, or recent games.", starters: ["Did you watch the game last night?", "Who's your favorite team?", "I love playing [sport]."] } ] }, 
                { category: "사교 활동 (Socializing)", items: [ { id: "meeting_new_people", title: "새로운 사람과 스몰톡 👋", description: "파티나 모임에서 처음 만난 사람과 가벼운 대화를 나눕니다.", baseContext: "You are someone the user has just met at a social event. Engage in small talk, ask about their interests, job, etc., to help them practice initiating conversations with new people.", baseContext_swapped:"You have just met someone (the user) at a social event. Engage in small talk, share your interests, or ask about theirs.", starters: ["Hi, I'm [Your Name]. Nice to meet you.", "So, what do you do for a living?", "Are you enjoying the event?"] }, { id: "inviting_friend", title: "친구 초대하기 (식사, 영화 등) 📧", description: "친구에게 식사나 영화 관람 등을 제안하고 약속을 잡습니다.", baseContext: "You are a friend of the user. The user wants to invite you out for a meal, movie, or another activity. Respond to their invitation, discuss plans, and confirm details.", baseContext_swapped:"You want to invite your friend (the user) for an activity. Make an invitation, suggest plans, and confirm details.", starters: ["Are you free to grab dinner on Friday?", "I was wondering if you'd like to see a movie with me.", "Let's hang out sometime next week."]}, { id: "accepting_declining_invitation", title: "초대 수락/거절하기 ✅❌", description: "친구의 초대에 대해 수락하거나 정중히 거절하는 방법을 연습합니다.", baseContext: "You have invited the user to an event. The user will practice accepting or declining your invitation politely.", baseContext_swapped:"You have been invited to an event by the user. Practice accepting or declining the invitation politely.", starters: ["Thanks for inviting me! I'd love to come.", "That sounds great, but I'm afraid I have other plans.", "I appreciate the invitation, but I don't think I can make it."] } ] }, 
                { category: "문제 해결 및 요청 (Problem Solving & Requests)", items: [ { id: "returning_item", title: "물건 환불/교환하기 🛍️", description: "상점에서 구매한 물건을 환불하거나 교환 요청하는 상황입니다.", baseContext: "You are a store clerk. The user wants to return or exchange an item they purchased. Ask for the reason, receipt, and guide them through the store's policy.", baseContext_swapped:"You want to return or exchange an item at a store. The user is the store clerk. Explain your reason and follow the process.", starters: ["I'd like to return this item, please.", "Can I exchange this for a different size?", "There's a problem with this product I bought."]}, { id: "tech_support", title: "기술 지원 문의하기 💻", description: "제품 사용 중 문제가 발생하여 기술 지원팀에 문의합니다.", baseContext: "You are a technical support agent. The user is calling about an issue with a product or service. Help them troubleshoot the problem or escalate the issue.", baseContext_swapped:"You are calling technical support for an issue with a product or service. The user is the support agent. Describe your problem and seek assistance.", starters: ["I'm having trouble with my [product/service].", "My internet isn't working.", "Could you help me fix this error?"] }, { id: "making_complaint", title: "불만 제기하기 (호텔, 식당 등) 😠", description: "서비스나 제품에 대한 불만을 정중하게 표현합니다.", baseContext: "You are a manager or customer service representative. The user has a complaint about a service or product. Listen to their concerns and try to resolve the issue.", baseContext_swapped:"You have a complaint about a service or product. The user is the manager or customer service representative. Express your dissatisfaction politely.", starters: ["I'm afraid I have a complaint about...", "I'm not satisfied with the service I received.", "Could I speak to the manager, please?"] } ] }, 
                { category: "건강 및 의료 (Health & Medical)", items: [ 
                    { id: "hospital_visit", title: "병원 방문 (일반 진료) 🏥", description: "의사나 간호사에게 증상을 설명하고 진료 관련 대화를 나눕니다.", 
                      baseContext: "You are a doctor or nurse at a hospital. The user is a patient explaining their symptoms (e.g., cold, flu, stomachache, minor injury). Ask clarifying questions, provide simple advice, or explain next steps like tests or prescriptions. Be empathetic and clear.", 
                      baseContext_swapped: "You are a patient visiting a hospital. The user is playing the role of the doctor/nurse. Describe common symptoms like a cold, headache, or stomach pain, or ask for advice. Respond to the doctor's/nurse's questions.", 
                      starters: ["I'd like to see a doctor. I'm not feeling well.", "I have a persistent cough and a sore throat.", "I think I might have sprained my ankle."] }, 
                    { id: "dentist_visit", title: "치과 방문 🦷", description: "치과 의사나 위생사에게 치아 문제를 설명하거나 정기 검진 관련 대화를 합니다.", 
                      baseContext: "You are a dentist or dental hygienist. The user is a patient, possibly for a check-up or a specific dental issue (e.g., toothache, cleaning). Ask about their dental history, current problems, and explain procedures or advice.", 
                      baseContext_swapped: "You are a patient at a dental clinic. The user is playing the role of the dentist/hygienist. You might be there for a regular check-up or a toothache. Describe your situation or ask questions about dental care. Respond to the dentist's/hygienist's questions.", 
                      starters: ["I have a toothache, and I'd like to make an appointment.", "I'm here for my 6-month check-up and cleaning.", "This tooth has been really sensitive to cold lately."] } 
                ]},
                { category: "특별한 상황 (Special Occasions)", items: [ { id: "birthday_party", title: "생일 파티 대화 🎉", description: "생일 축하 메시지를 전하고 파티에서 대화합니다.", baseContext: "You are a guest at a birthday party. The user is also a guest or the birthday person. Engage in light conversation, offer good wishes.", baseContext_swapped:"You are at a birthday party. The user is another guest or the birthday person. Engage in conversation and offer good wishes.", starters: ["Happy birthday!", "This is a great party!", "How are you enjoying your special day?"] }, { id: "congratulating_someone", title: "축하 표현하기 🥳", description: "다른 사람의 좋은 일(승진, 졸업 등)을 축하합니다.", baseContext: "You are a friend or colleague of the user. The user wants to congratulate you or someone else on an achievement. Respond appropriately.", baseContext_swapped:"You want to congratulate a friend or colleague (the user) on an achievement. Express your congratulations.", starters: ["Congratulations on your promotion!", "That's fantastic news! Well done.", "I'm so happy for you!"] } ] }, 
                { category: "사용자 설정", isCustomCategory: true, items: [ { id: "custom", title: "직접 입력 ✨", description: "연습하고 싶은 상황이나 주제를 아래에 자세히 입력해주세요.", baseContext: "", baseContext_swapped: "", starters: ["Let's talk about [your topic].", "I want to practice discussing [your situation].", "Can we simulate a conversation about [your scenario]?"] } ] } 
            ];
            const findScenarioById = (id) => { for (const category of scenarioTree) { const found = category.items.find(item => item.id === id); if (found) return { ...found, categoryTitle: category.category }; } return null; };
            
            // --- 함수 정의 ---
            function initializeAppLogic() { /* 이전과 동일 (단, currentScenario.baseContext 처리 시 역할 고려) */ const firebaseApp = initializeApp(firebaseConfig); auth = getAuth(firebaseApp); db = getFirestore(firebaseApp); onAuthStateChanged(auth, async (user) => { let finalUserId = null; if (user) { finalUserId = user.uid; } else { try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { const userCredential = await signInWithCustomToken(auth, __initial_auth_token); finalUserId = userCredential.user.uid; } else { const userCredential = await signInAnonymously(auth); finalUserId = userCredential.user.uid; } } catch (error) { console.error("로그인 실패:", error); } } if (finalUserId) { currentUserId = finalUserId; const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'info'); try { const docSnap = await getDoc(userProfileRef); let loadedScenarioData = findScenarioById("cafe"); let loadedFocusTopic = ''; let loadedCustomInput = ''; let loadedRoleIsUserPrimary = true; if (docSnap.exists()) { const profileData = docSnap.data(); const lastScenarioId = profileData.lastScenarioId; const foundScenarioFromDB = findScenarioById(lastScenarioId); if (foundScenarioFromDB) { loadedScenarioData = foundScenarioFromDB; if (foundScenarioFromDB.id === "custom" && profileData.lastCustomScenarioDetails) { loadedCustomInput = profileData.lastCustomScenarioDetails.description || ""; loadedScenarioData = { ...loadedScenarioData, title: profileData.lastCustomScenarioDetails.title || "사용자 설정 연습" }; } else if (foundScenarioFromDB.id !== "custom") { loadedFocusTopic = profileData.lastFocusTopic || ''; } loadedRoleIsUserPrimary = profileData.lastRoleIsUserPrimary !== undefined ? profileData.lastRoleIsUserPrimary : true; } } currentScenario = loadedScenarioData; currentFocusTopic = loadedFocusTopic; currentCustomScenarioInput = loadedCustomInput; userIsPlayingPrimaryRole = loadedRoleIsUserPrimary; updateScenarioDisplay(); focusTopicInput.value = currentFocusTopic; customScenarioInputElem.value = currentCustomScenarioInput; await setDoc(userProfileRef, { lastLogin: serverTimestamp(), lastScenarioId: currentScenario.id, lastRoleIsUserPrimary: userIsPlayingPrimaryRole, ...(currentScenario.id === "custom" && currentCustomScenarioInput ? { lastCustomScenarioDetails: { title: currentScenario.title, description: currentCustomScenarioInput } } : {}), ...(currentScenario.id !== "custom" ? { lastFocusTopic: currentFocusTopic } : {}) }, { merge: true }); } catch (error) { console.error("사용자 프로필 처리 오류:", error); currentScenario = findScenarioById("cafe"); updateScenarioDisplay(); } } isAuthReady = true; }); }
            
            function getDynamicContext() {
                if (!currentScenario) return "You are a general English language tutor. No scenario selected.";
                let scenarioSpecificContext = "";

                if (currentScenario.id === "custom") {
                    if (!currentCustomScenarioInput.trim()) return "You are a general English language tutor. The user hasn't specified a topic yet. Ask what they'd like to talk about.";
                    if (!userIsPlayingPrimaryRole) { 
                        scenarioSpecificContext = `ROLE SWAP: You are now the conversation partner based on the user's custom scenario: "${currentCustomScenarioInput}". The human user will act as your AI tutor or guide. Please respond naturally based on the scenario.`;
                    } else { 
                        scenarioSpecificContext = `You are a friendly and helpful English language tutor. The user wants to practice a conversation based on their custom scenario: "${currentCustomScenarioInput}". Act as a partner for this topic, ask relevant questions, and help with their English.`;
                    }
                } else {
                    if (userIsPlayingPrimaryRole) { 
                        scenarioSpecificContext = currentScenario.baseContext; 
                    } else { 
                        scenarioSpecificContext = currentScenario.baseContext_swapped || `ROLE SWAP! You are now taking on the role typically played by the AI in the "${currentScenario.title}" scenario. For example, if the user was the customer at a cafe, you are now the customer. The human user is playing the other part (e.g., barista). Please initiate or respond accordingly.`;
                    }
                }
                const focusTopicInstruction = (userIsPlayingPrimaryRole && currentFocusTopic && currentScenario.id !== "custom") 
                    ? `\n\nThe user also wants to focus on: "${currentFocusTopic}". Try to incorporate this into the conversation.` 
                    : '';
                return `${scenarioSpecificContext}${focusTopicInstruction}`;
            }
            
            async function callGeminiAPI(prompt) { /* 이전과 동일 (API 엔드포인트 및 응답 처리 로직 유지) */ const payload = { message: prompt }; const API_ENDPOINT = "https://magenta-morning-find.glitch.me/generate"; const apiUrl = API_ENDPOINT; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { let errorDetails = `서버 응답: ${response.statusText || '알 수 없는 오류'}`; try { const errorData = await response.json(); errorDetails = errorData.error || errorData.message || (typeof errorData === 'object' ? JSON.stringify(errorData) : String(errorData)); if (!errorDetails || errorDetails === '{}' || errorDetails.trim() === "") { errorDetails = `서버 응답: ${response.statusText || '오류 내용 없음'}`; } } catch (jsonError) { console.warn("API 오류 응답이 JSON이 아니므로 텍스트로 읽기를 시도합니다.", jsonError); try { const errorText = await response.text(); errorDetails = errorText.trim() || `서버 응답: ${response.statusText || '오류 내용 없음'}`; } catch (textError) { console.error("API 오류 응답을 텍스트로 읽는 데 실패했습니다.", textError); errorDetails = `서버 응답: ${response.statusText || '알 수 없는 오류'}, 응답 본문 읽기 실패`; } } const errorMsg = `API 요청 실패 (${response.status}): ${errorDetails}`; console.error("API Error Details:", errorDetails); throw new Error(errorMsg); } const result = await response.json(); if (result.text) { return result.text; } else if (result.generated_text) { return result.generated_text; } else if (result.reply) { return result.reply; } else if (typeof result === 'string') { return result; } else if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) { console.warn("Gemini API 형식의 응답을 받았습니다. Glitch 엔드포인트가 이 형식을 지원하는지 확인하세요."); return result.candidates[0].content.parts[0].text; } else { console.error("API 응답에서 텍스트를 추출할 수 없거나, 예상치 못한 구조입니다:", result); throw new Error('AI로부터 유효한 텍스트 응답을 받지 못했습니다.'); } } catch (error) { console.error("API 호출 중 예외 발생:", error); throw error; } }

            function updateScenarioDisplay(isConversationStarting = false) { /* 이전과 동일 (단, hide-after-conversation-start 클래스 처리 부분 수정) */ if (!currentScenario) return; const displayTitle = currentScenario.id === 'custom' ? (currentCustomScenarioInput ? `사용자 설정: ${currentCustomScenarioInput.substring(0,10)}...` : "사용자 설정") : (currentScenario.categoryTitle ? `${currentScenario.title.split(" ")[0]}` : currentScenario.title.split(" ")[0]); currentScenarioDisplay.textContent = displayTitle; headerTitle.title = currentScenario.title; scenarioTitleElem.textContent = currentScenario.id === "custom" ? (currentCustomScenarioInput ? `주제: ${currentCustomScenarioInput.substring(0,40)}...` : "사용자 설정 시나리오") : currentScenario.title; const elementsToHide = document.querySelectorAll('.hide-after-conversation-start'); if (isConversationStarting) { elementsToHide.forEach(el => el.classList.add('hidden')); scenarioDescriptionArea.classList.remove('pb-4', 'sm:pb-5'); scenarioTitleElem.classList.remove('mb-1.5'); scenarioTitleElem.classList.add('mb-0'); } else { elementsToHide.forEach(el => el.classList.remove('hidden')); scenarioDescriptionElem.textContent = currentScenario.id === "custom" ? scenarioTree.find(c=>c.isCustomCategory).items[0].description : currentScenario.description; starterPhrasesElem.innerHTML = ''; if (currentScenario.starters && currentScenario.starters.length > 0) { starterPhrasesContainer.classList.remove('hidden'); currentScenario.starters.forEach(starter => { const button = document.createElement('button'); button.className = "text-xs bg-sky-100 hover:bg-sky-200 text-sky-700 px-2 py-1 rounded-md shadow-sm transition-colors"; button.textContent = `"${starter}"`; button.onclick = () => { userInputElem.value = starter; }; starterPhrasesElem.appendChild(button); }); } else { starterPhrasesContainer.classList.add('hidden'); } if (currentScenario.id === "custom") { customScenarioGroup.classList.remove('hidden'); focusTopicGroup.classList.add('hidden'); } else { customScenarioGroup.classList.add('hidden'); focusTopicGroup.classList.remove('hidden'); } scenarioDescriptionArea.classList.remove('hidden'); scenarioDescriptionArea.classList.add('pb-4', 'sm:pb-5'); scenarioTitleElem.classList.add('mb-1.5'); scenarioTitleElem.classList.remove('mb-0'); } }
            
            function renderScenarioPicker() { /* 이전과 동일 (메뉴 스타일 조정 반영됨) */ scenarioDropdown.innerHTML = ''; scenarioTree.forEach(category => { const categoryDiv = document.createElement('div'); const categoryHeader = document.createElement('div'); categoryHeader.className = `flex justify-between items-center p-1.5 sm:p-2 hover:bg-sky-100 cursor-pointer text-slate-800 font-medium text-xs sm:text-sm category-header`; if (category.isCustomCategory && currentScenario && currentScenario.id === category.items[0].id) { categoryHeader.classList.add('scenario-picker-item-selected'); } const categoryTitleSpan = document.createElement('span'); categoryTitleSpan.textContent = category.category; categoryHeader.appendChild(categoryTitleSpan); if (!category.isCustomCategory) { const chevron = document.createElement('span'); const svgNS = "http://www.w3.org/2000/svg"; const svgEl = document.createElementNS(svgNS, "svg"); svgEl.setAttribute("viewBox", "0 0 20 20"); svgEl.setAttribute("fill", "currentColor"); svgEl.classList.add("w-5", "h-5", "transform", "transition-transform"); if (expandedCategories[category.category]) { svgEl.classList.add("rotate-90"); } else { svgEl.classList.remove("rotate-90"); } const pathEl = document.createElementNS(svgNS, "path"); pathEl.setAttribute("fill-rule", "evenodd"); pathEl.setAttribute("d", "M7.21 14.77a.75.75 0 0 1 .02-1.06L11.168 10 7.23 6.29a.75.75 0 1 1 1.04-1.08l4.5 4.25a.75.75 0 0 1 0 1.08l-4.5 4.25a.75.75 0 0 1-1.06-.02Z"); pathEl.setAttribute("clip-rule", "evenodd"); svgEl.appendChild(pathEl); chevron.appendChild(svgEl); categoryHeader.appendChild(chevron); } categoryHeader.onclick = (event) => { event.stopPropagation(); if (category.isCustomCategory) { handleScenarioSelect(category.items[0]); } else { expandedCategories[category.category] = !expandedCategories[category.category]; renderScenarioPicker(); } }; categoryDiv.appendChild(categoryHeader); if (expandedCategories[category.category] && !category.isCustomCategory) { const itemsDiv = document.createElement('div'); itemsDiv.className = "pl-3 border-l border-sky-200"; category.items.forEach(item => { const itemDiv = document.createElement('div'); itemDiv.className = `py-1 px-1.5 sm:py-1.5 sm:px-2 text-xs hover:bg-sky-50 cursor-pointer text-slate-600 scenario-picker-item`; if (currentScenario && currentScenario.id === item.id) { itemDiv.classList.add('scenario-picker-item-selected'); } itemDiv.textContent = item.title; itemDiv.onclick = (event) => { event.stopPropagation(); handleScenarioSelect(item); }; itemsDiv.appendChild(itemDiv); }); categoryDiv.appendChild(itemsDiv); } scenarioDropdown.appendChild(categoryDiv); }); }
            function toggleScenarioPicker() { /* 이전과 동일 */ showScenarioPicker = !showScenarioPicker; if (showScenarioPicker) { renderScenarioPicker(); scenarioDropdown.classList.remove('hidden'); scenarioDropdown.classList.add('fade-in'); } else { scenarioDropdown.classList.add('hidden'); expandedCategories = {}; } }
            function handleScenarioSelect(scenarioItem) { /* 이전과 동일 */ if (isLoading) { alert("AI가 응답 중일 때는 시나리오를 변경할 수 없습니다."); return; } const fullScenarioDetails = findScenarioById(scenarioItem.id); currentScenario = fullScenarioDetails; currentMessages = []; userInputElem.value = ''; suggestedRepliesList.innerHTML = ''; suggestedRepliesContainer.classList.add('hidden'); closeAnalysisModal(); userIsPlayingPrimaryRole = true; /* 시나리오 변경 시 기본 역할로 초기화 */ if (scenarioItem.id !== "custom") { currentCustomScenarioInput = ''; customScenarioInputElem.value = ''; } else { currentFocusTopic = ''; focusTopicInput.value = ''; } updateScenarioDisplay(false); renderMessages(); toggleScenarioPicker(); }
            function handleNewConversation() { /* 이전과 동일 */ if (isLoading) { alert("AI가 응답 중일 때는 새 대화를 시작할 수 없습니다."); return; } currentMessages = []; userInputElem.value = ''; suggestedRepliesList.innerHTML = ''; suggestedRepliesContainer.classList.add('hidden'); closeAnalysisModal(); userIsPlayingPrimaryRole = true; /* 새 대화 시 기본 역할로 초기화 */ updateScenarioDisplay(false); renderMessages(); const scenarioTitleForAlert = currentScenario.id === 'custom' ? (currentCustomScenarioInput || '사용자 설정') : currentScenario.title; alert(`"${scenarioTitleForAlert}" 시나리오로 새 대화를 시작합니다.`); }
            
            function simpleMarkdownToHtml(text) { /* 이전과 동일 */ if (!text) return ''; let html = text; html = html.replace(/\*\*(.*?)\*\*|__(.*?)__/g, '<strong>$1$2</strong>'); html = html.replace(/\*(.*?)\*|_(.*?)_/g, '<em>$1$2</em>'); html = html.replace(/~~(.*?)~~/g, '<del>$1</del>'); html = html.replace(/^\s*[\*\-\+]\s+(.*)/gm, '<li>$1</li>'); html = html.replace(/<\/li>\s*<li>/g, '</li><li>'); if (html.includes('<li>')) { const listItems = html.match(/<li>.*?<\/li>/g); if (listItems) { html = `<ul>${listItems.join('')}</ul>`; } } html = html.replace(/\n/g, '<br />'); html = html.replace(/<li><br \/>/g, '<li>'); html = html.replace(/<br \/><\/li>/g, '</li>'); html = html.replace(/<br \/>\s*<ul>/g, '<ul>'); html = html.replace(/<\/ul>\s*<br \/>/g, '</ul>'); return html; }

            function renderMessages() { /* 이전과 동일 */ messagesContainer.innerHTML = ''; currentMessages.forEach(msg => { const messageWrapper = document.createElement('div'); messageWrapper.className = `flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`; const messageBubble = document.createElement('div'); messageBubble.className = `max-w-3/4 sm:max-w-md lg:max-w-lg px-3 py-2 sm:px-4 sm:py-2.5 rounded-2xl shadow ${ msg.sender === 'user' ? 'user-bubble text-white rounded-br-none' : 'ai-bubble text-slate-800 rounded-bl-none' }`; messageBubble.innerHTML = simpleMarkdownToHtml(msg.text); messageWrapper.appendChild(messageBubble); messagesContainer.appendChild(messageWrapper); }); messagesContainer.scrollTop = messagesContainer.scrollHeight; }
            function setLoadingState(buttonId, textWhileLoading, isLoadingFlag) { /* 이전과 동일 */ const button = document.getElementById(buttonId); const buttonTextSpan = document.getElementById(`${buttonId}Text`); if (button && buttonTextSpan) { button.disabled = isLoadingFlag; buttonTextSpan.textContent = isLoadingFlag ? textWhileLoading : (buttonId === 'suggestRepliesButton' ? 'AI 응답 제안' : '내 문장 분석'); } }
            
            async function handleSendMessage() { 
                if (userInputElem.value.trim() === '' || isLoading) return; 
                if (currentScenario.id === "custom" && currentCustomScenarioInput.trim() === '' && currentMessages.length === 0) { 
                    alert("사용자 정의 시나리오 내용을 먼저 입력해주세요."); 
                    return; 
                } 
                const newUserMessage = { sender: 'user', text: userInputElem.value.trim(), timestamp: new Date() }; 
                currentMessages.push(newUserMessage); 
                renderMessages(); 
                const currentInputForAPI = userInputElem.value; 
                userInputElem.value = ''; 
                isLoading = true; 
                sendMessageButton.disabled = true; 
                sendMessageButton.innerHTML = `<svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"> <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path> </svg>`; 
                
                updateScenarioDisplay(true); 
                
                suggestedRepliesList.innerHTML = ''; 
                suggestedRepliesContainer.classList.add('hidden'); 
                closeAnalysisModal(); 
                if (db && currentUserId) { try { await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/conversations/${currentScenario.id === "custom" ? `custom_${currentCustomScenarioInput.substring(0,10).replace(/\s/g, '_')}` : currentScenario.id}/messages`), { ...newUserMessage, timestamp: serverTimestamp() }); } catch (error) { console.error("사용자 메시지 저장 오류:", error); } } 
                
                const contextForAI = getDynamicContext();
                // Glitch 엔드포인트가 대화 기록을 자체적으로 처리하지 않는다고 가정하고,
                // 현재 사용자 입력과 함께 전체 컨텍스트를 `message` 필드에 전달합니다.
                const promptForAI = `System Instruction: ${contextForAI}\n\nUser: ${currentInputForAPI}`;

                try { 
                    const aiResponseText = await callGeminiAPI(promptForAI); 
                    const newAiMessage = { sender: 'ai', text: aiResponseText, timestamp: new Date() }; 
                    currentMessages.push(newAiMessage); 
                    renderMessages(); 
                    if (db && currentUserId) { try { await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/conversations/${currentScenario.id === "custom" ? `custom_${currentCustomScenarioInput.substring(0,10).replace(/\s/g, '_')}` : currentScenario.id}/messages`), { ...newAiMessage, timestamp: serverTimestamp() }); } catch (error) { console.error("AI 메시지 저장 오류:", error); } } 
                } catch (error) { 
                    currentMessages.push({ sender: 'ai', text: `AI 응답 오류: ${error.message}`, timestamp: new Date() }); 
                    renderMessages(); 
                } finally { 
                    isLoading = false; 
                    sendMessageButton.disabled = false; 
                    sendMessageButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"> <path d="M3.5 2.75a.75.75 0 00-1.061.645l1.906 11.438a.75.75 0 001.412-.001L7.25 9.086l5.438-4.078a.75.75 0 00-.816-1.299L4.06 7.354 3.5 2.75zM2.75 16.5a.75.75 0 001.061.645l12.626-7.575a.75.75 0 000-1.29l-12.626-7.575A.75.75 0 002.75 1.5v15z" /> </svg>`; 
                } 
            }
            async function handleSuggestRepliesLogic() { /* 이전과 동일 */ if (isLoadingSuggestions || currentMessages.length === 0) return; isLoadingSuggestions = true; setLoadingState('suggestRepliesButton', '로딩중...', true); closeAnalysisModal(); try { const lastMessage = currentMessages[currentMessages.length - 1]; if (lastMessage.sender !== 'ai') { alert("AI의 응답 후에만 제안을 요청할 수 있습니다."); isLoadingSuggestions = false; setLoadingState('suggestRepliesButton', '', false); return; } const scenarioTitleForPrompt = currentScenario.id === "custom" ? (currentCustomScenarioInput || "사용자 정의 주제") : currentScenario.title; const focusTopicForPrompt = currentScenario.id === "custom" ? "" : (currentFocusTopic ? `The user is also focusing on "${currentFocusTopic}".` : ''); const prompt = `Based on the AI Tutor's last message: "${lastMessage.text}", provide ONLY 3 diverse and natural-sounding replies (short to medium length) that the user (who is learning English) could say next in the "${scenarioTitleForPrompt}" scenario. ${focusTopicForPrompt} Format them strictly as a numbered list, starting each item with a number and a period (e.g., 1. Suggestion one.). Do not include any introductory or explanatory text before or after the list. Consider the current role of the user: ${userIsPlayingPrimaryRole ? 'they are the primary actor in the scenario (e.g., customer, patient)' : 'they are playing the AI tutor/staff role'}.`; const suggestionsText = await callGeminiAPI(prompt); let parsedSuggestions = suggestionsText.split('\n').map(s => s.trim()).filter(s => s.length > 0 && /^\d+\.\s*.+/.test(s)).map(s => s.replace(/^\d+\.\s*/, '').trim()).filter(s => s.length > 0 && !s.toLowerCase().startsWith("here are") && !s.toLowerCase().includes("suggestion for")); suggestedRepliesList.innerHTML = ''; if (parsedSuggestions.length > 0) { parsedSuggestions.slice(0,3).forEach(reply => { const li = document.createElement('li'); li.className = "text-xs sm:text-sm text-sky-700 hover:text-sky-800 cursor-pointer p-1.5 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"; li.textContent = `"${reply}"`; li.onclick = () => { userInputElem.value = reply; suggestedRepliesList.innerHTML = ''; suggestedRepliesContainer.classList.add('hidden'); }; suggestedRepliesList.appendChild(li); }); suggestedRepliesContainer.classList.remove('hidden'); suggestedRepliesContainer.classList.add('fade-in'); } else { suggestedRepliesList.innerHTML = `<li class="text-slate-500">적절한 제안을 찾지 못했어요.</li>`; suggestedRepliesContainer.classList.remove('hidden');} } catch (error) { suggestedRepliesList.innerHTML = `<li class="text-red-500">제안 생성 오류: ${error.message}</li>`; suggestedRepliesContainer.classList.remove('hidden'); } finally { isLoadingSuggestions = false; setLoadingState('suggestRepliesButton', '', false); } }
            async function handleAnalyzeSentenceLogic() { /* 이전과 동일 (한국어 번역 로직 포함) */ if (isLoadingAnalysis) return; const userMessages = currentMessages.filter(msg => msg.sender === 'user'); if (userMessages.length === 0) { alert("분석할 사용자 메시지가 없습니다."); return; } isLoadingAnalysis = true; setLoadingState('analyzeSentenceButton', '분석중...', true); suggestedRepliesList.innerHTML = ''; suggestedRepliesContainer.classList.add('hidden'); closeAnalysisModal(); try { const lastUserMessage = userMessages[userMessages.length - 1]; const scenarioTitleForPrompt = currentScenario.id === "custom" ? (currentCustomScenarioInput || "사용자 정의 주제") : currentScenario.title; const focusTopicForPrompt = currentScenario.id === "custom" ? "" : (currentFocusTopic ? `They are focusing on "${currentFocusTopic}".` : ''); const analysisPrompt = `The user (learning English) said: "${lastUserMessage.text}" in the context of "${scenarioTitleForPrompt}" scenario. ${focusTopicForPrompt} Provide a structured analysis in English: **⭐ Overall Impression:** (Brief positive comment or general feel) **👍 Strengths:** (What was good about the sentence) **💡 Areas for Improvement:** **Grammar:** (Specific errors & corrections. If none, say "Grammar is good.") **Vocabulary:** (Word choice suggestions, better alternatives. If good, say "Vocabulary is appropriate.") **Naturalness/Fluency:** (Tips to sound more natural. If good, say "Sounds natural.") **✨ Suggested Revision (if any):** (Offer a revised version of the sentence if significant improvements can be made) Keep feedback constructive and easy for an English learner. After the English analysis, provide a concise summary of the feedback in Korean, under a heading "🇰🇷 한국어 요약:". This summary should highlight the main points of the feedback for a beginner to understand easily.`; const combinedAnalysisText = await callGeminiAPI(analysisPrompt); const koreanSummaryMarker = "🇰🇷 한국어 요약:"; const koreanSummaryIndex = combinedAnalysisText.indexOf(koreanSummaryMarker); let engAnalysis = ""; let korSummary = "한국어 요약을 생성하지 못했습니다."; if (koreanSummaryIndex !== -1) { engAnalysis = combinedAnalysisText.substring(0, koreanSummaryIndex).trim(); korSummary = combinedAnalysisText.substring(koreanSummaryIndex + koreanSummaryMarker.length).trim(); } else { engAnalysis = combinedAnalysisText.trim(); } englishAnalysisResultDiv.innerHTML = simpleMarkdownToHtml(engAnalysis); koreanAnalysisResultDiv.innerHTML = simpleMarkdownToHtml(korSummary); analysisModal.classList.remove('hidden'); analysisModal.classList.add('fade-in'); } catch (error) { englishAnalysisResultDiv.textContent = `분석 오류: ${error.message}`; koreanAnalysisResultDiv.textContent = ""; analysisModal.classList.remove('hidden'); analysisModal.classList.add('fade-in'); } finally { isLoadingAnalysis = false; setLoadingState('analyzeSentenceButton', '', false); } }
            
            function handleRoleSwapClick() { /* 이전과 동일 */ userIsPlayingPrimaryRole = !userIsPlayingPrimaryRole; currentMessages = []; renderMessages(); userInputElem.value = ''; updateScenarioDisplay(false); const currentRoleDescription = userIsPlayingPrimaryRole ? (currentScenario.id === 'custom' ? '직접 입력한 상황의 주도적인 역할' : `"${currentScenario.title}" 상황의 주도적인 역할 (예: 손님, 환자)`) : (currentScenario.id === 'custom' ? '직접 입력한 상황의 응답자 역할' : `"${currentScenario.title}" 상황의 응답자 역할 (예: 직원, 의사)`); alert(`역할이 변경되었습니다! 이제 당신은 "${currentRoleDescription}"입니다. AI가 먼저 말을 걸도록 하거나, 새로운 역할에 맞춰 대화를 시작해보세요.`); if (!userIsPlayingPrimaryRole && currentMessages.length === 0) { /* AI에게 먼저 말하도록 유도하는 로직 추가 가능 */ } }


            function closeAnalysisModal() {
                analysisModal.classList.add('hidden');
                englishAnalysisResultDiv.innerHTML = '';
                koreanAnalysisResultDiv.innerHTML = '';
            }

            // --- 이벤트 리스너 설정 ---
            scenarioPickerButton.addEventListener('click', toggleScenarioPicker);
            newConversationButton.addEventListener('click', handleNewConversation);
            sendMessageButton.addEventListener('click', handleSendMessage);
            userInputElem.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !isLoading) handleSendMessage(); });
            suggestRepliesButton.addEventListener('click', handleSuggestRepliesLogic);
            analyzeSentenceButton.addEventListener('click', handleAnalyzeSentenceLogic);
            roleSwapButton.addEventListener('click', handleRoleSwapClick);
            // extraFeatureButton 이벤트 리스너 제거
            closeAnalysisModalButton.addEventListener('click', closeAnalysisModal);
            confirmAnalysisModalButton.addEventListener('click', closeAnalysisModal);
            
            focusTopicInput.addEventListener('change', (e) => { currentFocusTopic = e.target.value; });
            customScenarioInputElem.addEventListener('change', (e) => { currentCustomScenarioInput = e.target.value; updateScenarioDisplay(); /* 사용자 정의 입력 시 헤더 제목 즉시 업데이트 */ });

            document.addEventListener('click', (event) => { // 드롭다운 외부 클릭 시 닫기
                if (scenarioPickerButton && !scenarioPickerButton.contains(event.target) && scenarioDropdown && !scenarioDropdown.contains(event.target) && showScenarioPicker) {
                    toggleScenarioPicker();
                }
                if (analysisModalContent && !analysisModalContent.contains(event.target) && analysisModal && !analysisModal.classList.contains('hidden') && analyzeSentenceButton && !analyzeSentenceButton.contains(event.target)) {
                    if (suggestRepliesButton && !suggestRepliesButton.contains(event.target)) { 
                         closeAnalysisModal();
                    }
                }
            });

            // --- 초기화 ---
            initializeAppLogic();
        }); // DOMContentLoaded 끝
    </script>
</body>
</html>
