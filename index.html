<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeakUp AI - AI ì˜ì–´ íšŒí™” íŠœí„°</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f7fafc; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-glow-blue { box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .btn-glow-amber { box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }
        .btn-glow-teal { box-shadow: 0 0 15px rgba(20, 184, 166, 0.4); }
        .btn-glow-indigo { box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }

        .gradient-bg { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
        .header-bg { background-color: #2c5282; }
        .chat-bg { background-color: #f8fafc; }
        .user-bubble { background-color: #3b82f6; }
        .ai-bubble { background-color: #e5e7eb; }
        .input-area-bg { background-color: #ffffff; }
        .modal-bg-overlay { background-color: rgba(0, 0, 0, 0.6); }
        .scenario-picker-item:hover { background-color: #eff6ff; }
        .scenario-picker-item-selected { background-color: #dbeafe; font-weight: 600; color: #1d4ed8; }
        .category-header:hover { background-color: #f0f9ff; }
        .ai-bubble ul { list-style-type: disc; padding-left: 20px; margin-top: 8px; margin-bottom: 8px; }
        .ai-bubble li { margin-bottom: 4px; }
        .compact-button {
            padding-top: 0.5rem; 
            padding-bottom: 0.5rem; 
            padding-left: 0.5rem; 
            padding-right: 0.5rem; 
            font-size: 0.8rem; 
            line-height: 1.1rem;
            min-height: 38px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            text-align: center;
        }
        .compact-button svg {
            margin-right: 0.25rem;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen gradient-bg p-2 sm:p-4">

    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col" style="height: calc(100vh - 30px); max-height: 800px;">
        <header class="header-bg text-white p-4 sm:p-5 rounded-t-2xl flex items-center justify-between relative shadow-md">
            <div class="flex items-center">
                <div class="relative" id="scenarioPickerContainer">
                    <button id="scenarioPickerButton" class="flex items-center text-sm sm:text-base bg-sky-700 hover:bg-sky-600 px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-400">
                        <span id="currentScenarioDisplay">ì‹œë‚˜ë¦¬ì˜¤</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 ml-1.5 opacity-80"> <path fillRule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clipRule="evenodd" /> </svg>
                    </button>
                    <div id="scenarioDropdown" class="hidden absolute left-0 mt-2 w-72 sm:w-80 bg-white rounded-lg shadow-xl z-20 border border-slate-200 max-h-96 overflow-y-auto custom-scrollbar fade-in">
                        </div>
                </div>
            </div>
            <h1 id="headerTitle" class="text-xl sm:text-2xl font-semibold text-center absolute left-1/2 transform -translate-x-1/2 truncate max-w-[40%] sm:max-w-[50%]" title="SpeakUp AI">SpeakUp AI</h1> 
            <div class="flex items-center space-x-2">
                <button id="helpButton" title="ë„ì›€ë§ ë³´ê¸°" class="text-sm sm:text-base bg-sky-700 hover:bg-sky-600 p-2 sm:p-2.5 rounded-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-400">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                    </svg>
                </button>
                <button id="newConversationButton" title="ìƒˆ ëŒ€í™” ì‹œì‘" class="text-sm sm:text-base bg-sky-700 hover:bg-sky-600 p-2 sm:p-2.5 rounded-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-400">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-5 h-5"> <path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /> </svg>
                </button>
            </div>
        </header>

        <div id="scenarioDescriptionArea" class="p-4 sm:p-5 border-b border-slate-200 bg-slate-50">
            <h2 id="scenarioTitle" class="text-lg sm:text-xl font-semibold text-sky-700 mb-1.5">ì‹œë‚˜ë¦¬ì˜¤ ì œëª©</h2>
            <p id="scenarioDescription" class="text-sm text-slate-600 mb-3 leading-relaxed hide-after-conversation-start">ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…</p>
            <div id="starterPhrasesContainer" class="mt-2 mb-3 hidden hide-after-conversation-start">
                <p class="text-xs font-semibold text-sky-600 mb-1.5">ì´ë ‡ê²Œ ì‹œì‘í•´ ë³´ì„¸ìš”:</p>
                <div id="starterPhrases" class="flex flex-wrap gap-2">
                    </div>
            </div>
            <div id="focusTopicGroup" class="hide-after-conversation-start">
                 <input type="text" id="focusTopicInput" placeholder="ì§‘ì¤‘ ì—°ìŠµ ì£¼ì œ (ì„ íƒ ì‚¬í•­)" class="w-full p-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow"/>
            </div>
            <div id="customScenarioGroup" class="hidden hide-after-conversation-start">
                <textarea id="customScenarioInput" placeholder="ì—°ìŠµí•˜ê³  ì‹¶ì€ ìƒí™©ì´ë‚˜ ëŒ€í™” ì£¼ì œë¥¼ ìì„¸íˆ ì…ë ¥í•´ì£¼ì„¸ìš”..." class="w-full p-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow" rows="3"></textarea>
            </div>
        </div>

        <div id="messagesContainer" class="flex-grow p-4 sm:p-5 overflow-y-auto chat-bg space-y-4 custom-scrollbar">
            </div>
        
        <div class="p-4 sm:p-5 border-t border-slate-200 input-area-bg">
            <div class="flex items-center space-x-3 mb-3"> 
                <input type="text" id="userInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="flex-grow p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow text-base shadow-sm"/>
                <button id="sendMessageButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-xl transition-all duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center shadow-md hover:shadow-lg btn-glow-blue focus:outline-none focus:ring-2 focus:ring-blue-300">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"> <path d="M3.5 2.75a.75.75 0 00-1.061.645l1.906 11.438a.75.75 0 001.412-.001L7.25 9.086l5.438-4.078a.75.75 0 00-.816-1.299L4.06 7.354 3.5 2.75zM2.75 16.5a.75.75 0 001.061.645l12.626-7.575a.75.75 0 000-1.29l-12.626-7.575A.75.75 0 002.75 1.5v15z" /> </svg>
                </button>
            </div>
            
            <div id="suggestedRepliesContainer" class="mb-2.5 p-2.5 bg-sky-50 rounded-lg hidden shadow fade-in">
                <h4 class="text-xs font-semibold text-sky-700 mb-1.5">AI ì‘ë‹µ ì œì•ˆ:</h4>
                <ul id="suggestedRepliesList" class="space-y-1.5">
                    </ul>
            </div>

            <div class="flex space-x-2"> 
                <button id="suggestRepliesButton" class="compact-button bg-amber-400 hover:bg-amber-500 text-amber-900 font-semibold rounded-lg transition-all duration-150 ease-in-out disabled:opacity-60 flex items-center justify-center shadow hover:shadow-md btn-secondary-glow focus:outline-none focus:ring-2 focus:ring-amber-300 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"> <path fillRule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.39-3.423 3.352c-.772.753-.235 2.047.788 2.225l4.21.728 1.948 4.24c.322.772 1.416.772 1.737 0l1.947-4.24 4.21-.728c1.023-.178 1.56-1.472.788-2.225l-3.423-3.352-4.753-.39-1.83-4.401zM12.267 8.197L10 12.488l-2.267-4.291-4.573-.374 3.29-3.218-1.043-4.493 4.065 1.956L10 0l2.528 1.978 4.065-1.956-1.043 4.493 3.29 3.218-4.573.374z" clipRule="evenodd" /> </svg> 
                    <span id="suggestRepliesButtonText">ì‘ë‹µ ì œì•ˆ</span>
                </button>
                <button id="analyzeSentenceButton" class="compact-button bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded-lg transition-all duration-150 ease-in-out disabled:opacity-60 flex items-center justify-center shadow-md hover:shadow-lg btn-tertiary-glow focus:outline-none focus:ring-2 focus:ring-teal-300 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"> <path fillRule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.39-3.423 3.352c-.772.753-.235 2.047.788 2.225l4.21.728 1.948 4.24c.322.772 1.416.772 1.737 0l1.947-4.24 4.21-.728c1.023-.178 1.56-1.472.788-2.225l-3.423-3.352-4.753-.39-1.83-4.401zM12.267 8.197L10 12.488l-2.267-4.291-4.573-.374 3.29-3.218-1.043-4.493 4.065 1.956L10 0l2.528 1.978 4.065-1.956-1.043 4.493 3.29 3.218-4.573.374z" clipRule="evenodd" /> </svg> 
                    <span id="analyzeSentenceButtonText">ë¬¸ì¥ ë¶„ì„</span>
                </button>
                <button id="roleSwapButton" class="compact-button bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg transition-all duration-150 ease-in-out disabled:opacity-60 flex items-center justify-center shadow-md hover:shadow-lg btn-glow-indigo focus:outline-none focus:ring-2 focus:ring-indigo-300 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                    </svg>
                    <span id="roleSwapButtonText">ì—­í•  ë³€ê²½</span>
                </button>
            </div>
        </div>
    </div>

    <div id="guideModal" class="hidden fixed inset-0 modal-bg-overlay flex items-center justify-center p-4 z-50 fade-in">
        <div id="guideModalContent" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl sm:text-2xl font-bold text-sky-600">SpeakUp AI ì‚¬ìš© ê°€ì´ë“œ ğŸš€</h2>
                <button id="closeGuideModalButton" class="text-slate-400 hover:text-slate-600 text-3xl transition-colors">&times;</button>
            </div>
            <div class="space-y-3 text-sm sm:text-base text-slate-700">
                <p><strong>1. ğŸ¤– ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ:</strong><br/> í™”ë©´ ì¢Œì¸¡ ìƒë‹¨ì˜ í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤ ë²„íŠ¼ (ì˜ˆ: <span class="font-semibold text-sky-600">ì¹´í˜ì—ì„œ</span>)ì„ í´ë¦­í•˜ì„¸ìš”. ë‹¤ì–‘í•œ ì¹´í…Œê³ ë¦¬ë³„ ëŒ€í™” ìƒí™©ì„ ì„ íƒí•˜ê±°ë‚˜, 'âœ¨ ì‚¬ìš©ì ì„¤ì •'ì„ í†µí•´ ì§ì ‘ ì›í•˜ëŠ” ì£¼ì œë¥¼ ì…ë ¥í•˜ì—¬ ì—°ìŠµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <p><strong>2. ğŸ¯ ì§‘ì¤‘ ì£¼ì œ (ì„ íƒ ì‚¬í•­):</strong><br/> ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª… ì•„ë˜ì— ìˆëŠ” ì…ë ¥ì°½ì— íŠ¹ë³„íˆ ì—°ìŠµí•˜ê³  ì‹¶ì€ ì–´íœ˜ë‚˜ í‘œí˜„ ë“±ì„ ì…ë ¥í•˜ë©´ AIê°€ ëŒ€í™”ì— ë” ì˜ ë°˜ì˜í•´ì¤ë‹ˆë‹¤. (ì‚¬ìš©ì ì„¤ì • ì‹œë‚˜ë¦¬ì˜¤ì—ì„œëŠ” ì´ ì…ë ¥ì°½ì´ ì—†ìŠµë‹ˆë‹¤.)</p>
                <p><strong>3. ğŸ—£ï¸ ëŒ€í™” ì‹œì‘í•˜ê¸°:</strong><br/> í™”ë©´ ìƒë‹¨ì— í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤ì— ë§ëŠ” <span class="text-sky-600 font-medium">"ì´ë ‡ê²Œ ì‹œì‘í•´ ë³´ì„¸ìš”:"</span> ì˜ˆì‹œ ë¬¸ì¥ë“¤ì´ ì œê³µë©ë‹ˆë‹¤. í´ë¦­í•˜ë©´ ë°”ë¡œ ì…ë ¥ì°½ì— ì ìš©ë¼ìš”! ë˜ëŠ” ì§ì ‘ ì˜ì–´ë¡œ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•˜ê³  ì „ì†¡ (ì¢…ì´ë¹„í–‰ê¸° ì•„ì´ì½˜) ë²„íŠ¼ì„ ëˆŒëŸ¬ AI íŠœí„°ì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
                <p><strong>4. âœ¨ AI ê¸°ëŠ¥ í™œìš©í•˜ê¸° (ì…ë ¥ì°½ í•˜ë‹¨ ë²„íŠ¼):</strong></p>
                <ul class="list-disc list-inside pl-4 space-y-1">
                    <li><strong class="text-amber-600">ì‘ë‹µ ì œì•ˆ:</strong> ëŒ€í™” ì¤‘ ì–´ë–¤ ë§ì„ í•´ì•¼ í• ì§€ ë§‰ë§‰í•  ë•Œ ëˆ„ë¥´ë©´, AIê°€ 3ê°€ì§€ ì‘ë‹µ ì˜ˆì‹œë¥¼ ì¶”ì²œí•´ì¤ë‹ˆë‹¤.</li>
                    <li><strong class="text-teal-600">ë¬¸ì¥ ë¶„ì„:</strong> ë°©ê¸ˆ ë‚´ê°€ ë³´ë‚¸ ì˜ì–´ ë¬¸ì¥ì— ëŒ€í•´ AIê°€ ë¬¸ë²•, ì–´íœ˜, ìì—°ìŠ¤ëŸ¬ì›€ ë“±ì„ ë¶„ì„í•˜ê³ , <span class="text-sky-600">í•œêµ­ì–´ ìš”ì•½</span>ë„ í•¨ê»˜ ì œê³µí•©ë‹ˆë‹¤.</li>
                    <li><strong class="text-indigo-600">ì—­í•  ë³€ê²½:</strong> í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ì‚¬ìš©ìì™€ AIì˜ ì—­í• ì„ ì„œë¡œ ë°”ê¿‰ë‹ˆë‹¤. (ì˜ˆ: ì†ë‹˜ â†” ì ì›) ì—­í• ì´ ë°”ë€Œë©´ ìƒˆë¡œìš´ ì‹œì‘ í‘œí˜„ë„ ì œê³µë©ë‹ˆë‹¤.</li>
                </ul>
                <p><strong>5. ğŸ”„ ìƒˆ ëŒ€í™” ì‹œì‘:</strong><br/> í™”ë©´ ìš°ì¸¡ ìƒë‹¨ì˜ ìƒˆë¡œê³ ì¹¨ ì•„ì´ì½˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, í˜„ì¬ ì„ íƒëœ ì‹œë‚˜ë¦¬ì˜¤ (ë˜ëŠ” ì‚¬ìš©ì ì„¤ì • ì£¼ì œ) ë° ì—­í• ë¡œ ëŒ€í™” ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ê³  ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì—°ìŠµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            <button id="confirmGuideModalButton" class="mt-6 w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-sky-400">
                ì•Œê² ìŠµë‹ˆë‹¤!
            </button>
        </div>
    </div>

    <div id="analysisModal" class="hidden fixed inset-0 modal-bg-overlay flex items-center justify-center p-4 z-50 fade-in">
        <div id="analysisModalContent" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl sm:text-2xl font-semibold text-sky-700">âœ¨ ë‚´ ë¬¸ì¥ ë¶„ì„ ê²°ê³¼</h3>
                <button id="closeAnalysisModalButtonFromAnalysis" class="text-slate-400 hover:text-slate-600 text-3xl transition-colors">&times;</button>
            </div>
            <div id="englishAnalysisResult" class="mb-5">
                <h4 class="text-lg font-medium text-slate-800 mb-1.5">ğŸ“ ì˜ì–´ í”¼ë“œë°±:</h4>
                <div class="text-base text-slate-700 whitespace-pre-wrap leading-relaxed p-3 bg-slate-50 rounded-md border border-slate-200"></div>
            </div>
            <div id="koreanAnalysisResult">
                <h4 class="text-lg font-medium text-slate-800 mb-1.5">ğŸ‡°ğŸ‡· í•œêµ­ì–´ ìš”ì•½:</h4>
                <div class="text-base text-slate-700 whitespace-pre-wrap leading-relaxed p-3 bg-sky-50 rounded-md border border-sky-200"></div>
            </div>
            <button id="confirmAnalysisModalButtonFromAnalysis" class="mt-6 w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-sky-400">
                í™•ì¸í–ˆì–´ìš”!
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => { 
            const scenarioPickerButton = document.getElementById('scenarioPickerButton');
            const currentScenarioDisplay = document.getElementById('currentScenarioDisplay');
            const scenarioDropdown = document.getElementById('scenarioDropdown');
            const headerTitle = document.getElementById('headerTitle'); 
            const newConversationButton = document.getElementById('newConversationButton');
            const helpButton = document.getElementById('helpButton'); 
            
            const scenarioDescriptionArea = document.getElementById('scenarioDescriptionArea');
            const scenarioTitleElem = document.getElementById('scenarioTitle');
            const scenarioDescriptionElem = document.getElementById('scenarioDescription');
            const starterPhrasesContainer = document.getElementById('starterPhrasesContainer');
            const starterPhrasesElem = document.getElementById('starterPhrases');
            const focusTopicGroup = document.getElementById('focusTopicGroup');
            const focusTopicInput = document.getElementById('focusTopicInput');
            const customScenarioGroup = document.getElementById('customScenarioGroup');
            const customScenarioInputElem = document.getElementById('customScenarioInput');

            const messagesContainer = document.getElementById('messagesContainer');
            const userInputElem = document.getElementById('userInput'); 
            const sendMessageButton = document.getElementById('sendMessageButton');

            const suggestedRepliesContainer = document.getElementById('suggestedRepliesContainer');
            const suggestedRepliesList = document.getElementById('suggestedRepliesList');
            const suggestRepliesButton = document.getElementById('suggestRepliesButton');
            const suggestRepliesButtonText = document.getElementById('suggestRepliesButtonText');
            
            const analyzeSentenceButton = document.getElementById('analyzeSentenceButton');
            const analyzeSentenceButtonText = document.getElementById('analyzeSentenceButtonText');
            
            const analysisModal = document.getElementById('analysisModal');
            const analysisModalContent = document.getElementById('analysisModalContent');
            const englishAnalysisResultDiv = document.querySelector('#englishAnalysisResult div');
            const koreanAnalysisResultDiv = document.querySelector('#koreanAnalysisResult div');
            const closeAnalysisModalButtonFromAnalysis = document.getElementById('closeAnalysisModalButtonFromAnalysis'); 
            const confirmAnalysisModalButtonFromAnalysis = document.getElementById('confirmAnalysisModalButtonFromAnalysis'); 
            
            const roleSwapButton = document.getElementById('roleSwapButton');

            const guideModal = document.getElementById('guideModal');
            const guideModalContent = document.getElementById('guideModalContent');
            const closeGuideModalButton = document.getElementById('closeGuideModalButton');
            const confirmGuideModalButton = document.getElementById('confirmGuideModalButton');


            let currentMessages = [];
            let currentScenario; 
            let currentFocusTopic = '';
            let currentCustomScenarioInput = '';
            let isLoading = false;
            let isLoadingSuggestions = false;
            let isLoadingAnalysis = false;
            let showScenarioPicker = false;
            let expandedCategories = {}; 
            let db, auth, currentUserId, isAuthReady = false;
            let userIsPlayingPrimaryRole = true; 

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'ai-tutor-html-default-v1';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                apiKey: "YOUR_API_KEY", 
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

            const scenarioTree = [ 
                { category: "ì¼ìƒ ìƒí™œ (Everyday Life)", items: [ 
                    { id: "cafe", title: "ì¹´í˜ì—ì„œ ì£¼ë¬¸í•˜ê¸° â˜•", description: "ë°”ë¦¬ìŠ¤íƒ€ì—ê²Œ ì»¤í”¼ë¥¼ ì£¼ë¬¸í•˜ê³  ê°„ë‹¨í•œ ìš”ì²­ì„ í•´ë³´ì„¸ìš”. AIëŠ” ì¹œì ˆí•œ ë°”ë¦¬ìŠ¤íƒ€ ì—­í• ì„ í•©ë‹ˆë‹¤.", 
                      baseContext: "You are a friendly barista. The user is ordering coffee. Respond concisely (1-2 sentences), ask one question at a time if necessary, and assist with their order. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You are a customer ordering coffee. The user is the barista. Make your order and ask any questions you might have. Keep your requests concise.", 
                      starters_userAsPrimary: ["Hi, can I get a latte?", "Hello! What do you recommend?", "I'd like to order a coffee, please."],
                      starters_userAsOther: ["Hi there! What can I get for you today?", "Welcome! Ready to order?", "Hello! How can I help you?"] }, 
                    { id: "grocery_shopping", title: "ì‹ë£Œí’ˆì ì—ì„œ ì¥ë³´ê¸° ğŸ›’", description: "ì ì›ì—ê²Œ ë¬¼ê±´ ìœ„ì¹˜ë¥¼ ë¬»ê±°ë‚˜ ê³„ì‚°í•  ë•Œ ëŒ€í™”í•´ë³´ì„¸ìš”. AIëŠ” ì¹œì ˆí•œ ì ì› ì—­í• ì„ í•©ë‹ˆë‹¤.", 
                      baseContext: "You are a helpful grocery store clerk. The user is shopping. Respond concisely (1-2 sentences) and help them find items or checkout. Ask one question at a time if needed. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You are a customer at a grocery store. The user is the clerk. Ask for help or proceed to checkout concisely.",
                      starters_userAsPrimary: ["Excuse me, where can I find the milk?", "How much is this?", "I'd like to pay for these items."],
                      starters_userAsOther: ["Hi! Can I help you find something?", "Are you ready to check out?", "Did you find everything okay?"] },
                    { id: "making_appointments", title: "ì˜ˆì•½í•˜ê¸° (ë¯¸ìš©ì‹¤, ë³‘ì› ë“±) ğŸ—“ï¸", description: "ì „í™”ë‚˜ ë°©ë¬¸ì„ í†µí•´ ì˜ˆì•½í•˜ëŠ” ìƒí™©ì„ ì—°ìŠµí•©ë‹ˆë‹¤. AIëŠ” ì ‘ìˆ˜ì› ì—­í• ì„ í•©ë‹ˆë‹¤.", 
                      baseContext: "You are a receptionist at a salon/clinic. The user wants to make an appointment. Guide them concisely (1-2 sentences per turn), asking one question at a time for preferences and confirming details. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You want to make an appointment. The user is the receptionist. State your needs concisely.",
                      starters_userAsPrimary: ["I'd like to make an appointment for a haircut.", "Do you have any openings next Tuesday?", "Can I book a check-up for this week?"],
                      starters_userAsOther: ["Hello, [Salon/Clinic Name], how can I help you?", "Good morning! How may I assist you with scheduling?", "Are you looking to book an appointment?"] },
                    { id: "daily_routine_talk", title: "ì¼ìƒ ì´ì•¼ê¸°í•˜ê¸° â˜€ï¸", description: "í•˜ë£¨ ì¼ê³¼ë‚˜ ì£¼ë§ ê³„íš ë“± ì¼ìƒì ì¸ ì£¼ì œë¡œ ëŒ€í™”í•©ë‹ˆë‹¤. AIëŠ” ì¹œêµ¬ ì—­í• ì„ í•©ë‹ˆë‹¤.", 
                      baseContext: "You are a friend. The user wants to talk about daily life. Engage in a casual, concise (1-2 sentences per turn) conversation. Ask one question at a time if needed. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You are talking to a friend (the user). Share something about your day or ask about theirs, keeping it concise.",
                      starters_userAsPrimary: ["How was your day?", "What are you up to this weekend?", "I usually [activity] in the morning."],
                      starters_userAsOther: ["Hey! What's new?", "How's it going?", "Anything interesting happen today?"] },
                    { id: "public_transportation", title: "ëŒ€ì¤‘êµí†µ ì´ìš©í•˜ê¸° ğŸšŒ", description: "ë²„ìŠ¤ë‚˜ ì§€í•˜ì²  í‘œë¥¼ ì‚¬ê±°ë‚˜ ê¸¸ì„ ë¬»ëŠ” ìƒí™©ì…ë‹ˆë‹¤. AIëŠ” ì—­ë¬´ì› ë˜ëŠ” ë‹¤ë¥¸ ìŠ¹ê° ì—­í• ì„ í•©ë‹ˆë‹¤.", 
                      baseContext: "You are a public transport staff or a helpful passenger. The user needs help. Provide clear, concise (1-2 sentences per turn) assistance. Ask one question at a time if needed. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You need help with public transport. The user is staff/passenger. Ask your question concisely.",
                      starters_userAsPrimary: ["Which bus goes to downtown?", "How much is a single ride ticket?", "Is this the platform for the express train?"],
                      starters_userAsOther: ["Can I help you with something?", "Are you looking for a specific line?", "Tickets can be purchased over there."] }
                ]}, 
                { category: "ì—¬í–‰ (Travel)", items: [ 
                    { id: "airport_checkin", title: "ê³µí•­ ì²´í¬ì¸ âœˆï¸", description: "ê³µí•­ ì²´í¬ì¸ ì¹´ìš´í„°ì—ì„œ íƒ‘ìŠ¹ ìˆ˜ì†ì„ ì§„í–‰í•©ë‹ˆë‹¤.", baseContext: "You are an airline check-in agent. The user is checking in for a flight. Ask for passport/ticket, discuss baggage, seat preferences. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are at the airport checking in for your flight. The user is the check-in agent. Provide your documents and discuss your flight details concisely.", starters_userAsPrimary: ["I'd like to check in for my flight to London.", "Here's my passport and ticket.", "Can I have a window seat, please?"], starters_userAsOther: ["Good [morning/afternoon/evening]! May I see your passport and ticket, please?", "Where are you flying to today?", "Do you have any bags to check in?"] }, 
                    { id: "hotel_checkin", title: "í˜¸í…” ì²´í¬ì¸ ğŸ¨", description: "í˜¸í…” í”„ë¡ íŠ¸ì—ì„œ ì˜ˆì•½ í™•ì¸ ë° ì²´í¬ì¸ì„ í•©ë‹ˆë‹¤.", baseContext: "You are a hotel receptionist. The user is checking in. Confirm reservation, explain amenities, answer questions. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are checking into a hotel. The user is the receptionist. Provide your reservation details and ask any necessary questions concisely.", starters_userAsPrimary: ["I have a reservation under the name [Your Name].", "Could you tell me what time breakfast is served?", "Is there Wi-Fi in the room?"], starters_userAsOther: ["Welcome to our hotel! How can I help you?", "Do you have a reservation with us?", "May I have your name, please?"] }, 
                    { id: "asking_directions", title: "ê¸¸ ë¬»ê¸° ğŸ—ºï¸", description: "ì—¬í–‰ ì¤‘ ëª¨ë¥´ëŠ” ê³³ì—ì„œ ê¸¸ì„ ë¬»ëŠ” ìƒí™©ì…ë‹ˆë‹¤.", baseContext: "You are a local resident. The user is a tourist asking for directions. Provide clear, concise (1-2 sentences) instructions and be helpful. Ask one question at a time if needed.", baseContext_swapped:"You are a tourist asking for directions. The user is a local resident. Ask for help finding your way concisely.", starters_userAsPrimary: ["Excuse me, how can I get to the museum?", "Could you show me on the map?", "Is this the right way to the train station?"], starters_userAsOther: ["Yes, how can I help you?", "Where are you trying to go?", "Sure, I can help with that."] }, 
                    { id: "ordering_at_restaurant_travel", title: "ì—¬í–‰ ì¤‘ ì‹ë‹¹ ì£¼ë¬¸ ğŸ½ï¸", description: "ì—¬í–‰ì§€ ì‹ë‹¹ì—ì„œ ìŒì‹ì„ ì£¼ë¬¸í•˜ê³  í˜„ì§€ ìŒì‹ì— ëŒ€í•´ ì§ˆë¬¸í•©ë‹ˆë‹¤.", baseContext: "You are a waiter/waitress in a tourist-friendly restaurant. The user is ordering food and might ask about local specialties. Be patient and helpful. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are a customer at a restaurant in a tourist area. The user is the waiter/waitress. Order food and ask about the menu concisely.", starters_userAsPrimary: ["What's the local specialty here?", "I'd like to try something traditional.", "Can you recommend a dish?"], starters_userAsOther: ["Welcome! Are you ready to order, or do you need a few more minutes?", "Can I get you started with something to drink?", "What can I get for you?"] },
                    { id: "booking_tour", title: "ì—¬í–‰ ìƒí’ˆ ì˜ˆì•½í•˜ê¸° ğŸï¸", description: "í˜„ì§€ íˆ¬ì–´ë‚˜ ì•¡í‹°ë¹„í‹°ë¥¼ ì˜ˆì•½í•˜ëŠ” ìƒí™©ì…ë‹ˆë‹¤.", baseContext: "You are a travel agent or tour operator. The user wants to book a tour or activity. Provide information about options, prices, and make the booking. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You want to book a local tour or activity. The user is the travel agent. Inquire about options and make a booking concisely.", starters_userAsPrimary: ["I'm interested in booking a city tour.", "What kind of tours do you offer?", "How much does the [tour name] cost?"], starters_userAsOther: ["Hello! How can I help you plan your activities today?", "We have several tours available. What are you interested in?", "Certainly, let me check the availability for you."] },
                    { id: "at_immigration", title: "ì…êµ­ ì‹¬ì‚¬ëŒ€ì—ì„œ ğŸ›‚", description: "ê³µí•­ ì…êµ­ ì‹¬ì‚¬ëŒ€ì—ì„œ ì‹¬ì‚¬ê´€ì˜ ì§ˆë¬¸ì— ë‹µë³€í•©ë‹ˆë‹¤.", baseContext: "You are an immigration officer. The user is arriving in the country. Ask about the purpose of their visit, length of stay, and check their documents. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are at immigration control upon arriving in a new country. The user is the immigration officer. Answer their questions about your visit concisely.", starters_userAsPrimary: ["Good morning. May I see your passport?", "What is the purpose of your visit?", "How long do you plan to stay?"], starters_userAsOther: ["Next, please. Passport and landing card.", "Good [morning/afternoon]. Welcome to [Country].", "What is the purpose of your visit to [Country]?"] }
                ]}, 
                { category: "ì§ì¥ ìƒí™œ (Work & Business)", items: [ 
                    { id: "job_interview", title: "ë©´ì ‘ ë³´ê¸° ğŸ’¼", description: "êµ¬ì§ ë©´ì ‘ ìƒí™©ì„ ì—°ìŠµí•©ë‹ˆë‹¤. ìê¸°ì†Œê°œ, ì§ˆë¬¸ ë‹µë³€ ë“±", baseContext: "You are an interviewer for a job position. The user is a candidate. Ask common interview questions and evaluate their responses in English. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are a candidate at a job interview. The user is the interviewer. Answer questions about your qualifications and experience concisely.", starters_userAsPrimary: ["Tell me about yourself.", "Why are you interested in this position?", "What are your strengths?"], starters_userAsOther: ["Thank you for coming in today. Please, have a seat.", "So, tell me a little bit about yourself.", "Why are you interested in this role at our company?"] }, 
                    { id: "meeting_colleagues", title: "ë™ë£Œì™€ íšŒì˜í•˜ê¸° ğŸ‘¥", description: "ì—…ë¬´ ê´€ë ¨ íšŒì˜ì—ì„œ ì˜ê²¬ì„ ì œì‹œí•˜ê³  í† ë¡ í•©ë‹ˆë‹¤.", baseContext: "You are a colleague in a business meeting. The user is participating in the meeting. Discuss agenda items, share opinions, and collaborate. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are participating in a business meeting with colleagues. The user is one of your colleagues. Share your opinions and discuss agenda items concisely.", starters_userAsPrimary: ["I'd like to suggest an idea.", "What are your thoughts on this proposal?", "Let's discuss the next steps."], starters_userAsOther: ["Okay team, let's get started. The first item on the agenda is...", "Does anyone have any initial thoughts on this?", "Thanks for sharing, [User's Name]. What does everyone else think?"] }, 
                    { id: "phone_call_business", title: "ì—…ë¬´ ì „í™” í†µí™” ğŸ“", description: "ë¹„ì¦ˆë‹ˆìŠ¤ ëª©ì ìœ¼ë¡œ ì „í™”ë¥¼ ê±¸ê±°ë‚˜ ë°›ëŠ” ìƒí™©ì…ë‹ˆë‹¤.", baseContext: "You are a business professional on a phone call. The user is either initiating or receiving a business call. Handle inquiries, schedule meetings, or discuss projects professionally. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are making or receiving a business phone call. The user is the other party. Discuss professional matters, schedule appointments, or make inquiries concisely.", starters_userAsPrimary: ["Hello, this is [Your Name] from [Your Company].", "May I speak to Mr./Ms. [Name]?", "I'm calling to inquire about..."], starters_userAsOther: ["Good morning, [Company Name], [Your Name] speaking. How can I help you?", "Hello, thank you for calling. This is [Your Name].", "[User's Name] speaking."] },
                    { id: "presentation_qna", title: "ë°œí‘œ í›„ ì§ˆì˜ì‘ë‹µ ğŸ¤", description: "ë°œí‘œë¥¼ ë§ˆì¹œ í›„ ì²­ì¤‘ì˜ ì§ˆë¬¸ì— ë‹µë³€í•˜ëŠ” ìƒí™©ì…ë‹ˆë‹¤.", baseContext: "You are an audience member after a presentation. The user is the presenter. Ask relevant questions about their presentation. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are the presenter who has just finished a presentation. The user is an audience member asking questions. Answer their questions clearly and concisely.", starters_userAsPrimary: ["Thank you for your presentation. I have a question about...", "Could you elaborate on [specific point]?", "What are the implications of your findings?"], starters_userAsOther: ["Thank you for that insightful presentation. We now have some time for questions.", "Any questions for our speaker?", "Yes, the person in the back?"] },
                    { id: "networking_event", title: "ë„¤íŠ¸ì›Œí‚¹ í–‰ì‚¬ ğŸ¤", description: "ì—…ê³„ í–‰ì‚¬ì—ì„œ ìƒˆë¡œìš´ ì‚¬ëŒë“¤ê³¼ êµë¥˜í•˜ë©° ëŒ€í™”í•©ë‹ˆë‹¤.", baseContext: "You are attending a networking event. The user is also an attendee. Initiate or respond to conversations to build professional connections. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are attending a networking event. The user is another attendee. Engage in conversation to build professional connections concisely.", starters_userAsPrimary: ["Hi, I'm [Your Name]. What brings you to this event?", "That's an interesting point. Could you tell me more?", "It was nice talking to you. Here's my card."], starters_userAsOther: ["Hello! Enjoying the event?", "Hi, I don't think we've met. I'm [Your Name].", "What line of work are you in?"] }
                ]}, 
                { category: "ì·¨ë¯¸ ë° ê´€ì‹¬ì‚¬ (Hobbies & Interests)", items: [ 
                    { id: "discussing_movie", title: "ì˜í™” ì´ì•¼ê¸°í•˜ê¸° ğŸ¬", description: "ìµœê·¼ì— ë³¸ ì˜í™”ë‚˜ ì¢‹ì•„í•˜ëŠ” ì˜í™”ì— ëŒ€í•´ ì¹œêµ¬ì™€ ì´ì•¼ê¸°í•©ë‹ˆë‹¤.", baseContext: "You are a friend discussing movies with the user. Talk about recent movies, favorite genres, actors, etc. Encourage the user to express their opinions in English. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are discussing movies with a friend (the user). Share your opinions about movies, genres, actors, etc. concisely.", starters_userAsPrimary: ["Have you seen any good movies lately?", "What's your favorite type of movie?", "I recently watched [Movie Title]..."], starters_userAsOther: ["So, any new movies you'd recommend?", "I'm looking for a good movie to watch, any ideas?", "What did you think of [Movie Title]?"] }, 
                    { id: "talking_about_music", title: "ìŒì•… ì·¨í–¥ ê³µìœ í•˜ê¸° ğŸ¶", description: "ì¢‹ì•„í•˜ëŠ” ìŒì•… ì¥ë¥´, ê°€ìˆ˜, ë…¸ë˜ì— ëŒ€í•´ ì´ì•¼ê¸° ë‚˜ëˆ•ë‹ˆë‹¤.", baseContext: "You are a friend talking about music. Discuss favorite genres, artists, songs, concerts, etc. Help the user share their musical tastes in English. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are talking about music with a friend (the user). Share your musical tastes, favorite artists, songs, etc. concisely.", starters_userAsPrimary: ["What kind of music do you like?", "Who's your favorite singer?", "Have you heard the new song by [Artist]?"], starters_userAsOther: ["I'm always looking for new music. Any recommendations?", "What have you been listening to lately?", "Do you like [Genre/Artist]?"] }, 
                    { id: "discussing_books", title: "ì±…ì— ëŒ€í•´ ëŒ€í™”í•˜ê¸° ğŸ“š", description: "ì½ì€ ì±…ì´ë‚˜ ì¢‹ì•„í•˜ëŠ” ì‘ê°€, ì¥ë¥´ì— ëŒ€í•´ ì´ì•¼ê¸°í•©ë‹ˆë‹¤.", baseContext: "You are a fellow book lover. The user wants to discuss books they've read, favorite authors, or genres. Share your thoughts and ask them about theirs. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are discussing books with a fellow book lover (the user). Talk about books you've read, favorite authors, or genres concisely.", starters_userAsPrimary: ["What are you reading currently?", "Do you have a favorite author?", "I just finished a great book called..."], starters_userAsOther: ["Read any good books lately?", "I'm looking for a new book. Any suggestions?", "What kind of books do you usually enjoy?"] }, 
                    { id: "talking_about_sports", title: "ìŠ¤í¬ì¸  ì´ì•¼ê¸°í•˜ê¸° âš½", description: "ì¢‹ì•„í•˜ëŠ” ìŠ¤í¬ì¸ , íŒ€, ì„ ìˆ˜ì— ëŒ€í•´ ì´ì•¼ê¸°í•©ë‹ˆë‹¤.", baseContext: "You are a sports enthusiast. The user wants to talk about sports. Discuss favorite sports, teams, players, recent games, etc. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are talking about sports with an enthusiast (the user). Discuss your favorite sports, teams, players, or recent games concisely.", starters_userAsPrimary: ["Did you watch the game last night?", "Who's your favorite team?", "I love playing [sport]."], starters_userAsOther: ["That was some game last night, wasn't it?", "Are you a fan of [Sport/Team]?", "What sports do you follow?"] } 
                ]}, 
                { category: "ì‚¬êµ í™œë™ (Socializing)", items: [ 
                    { id: "meeting_new_people", title: "ìƒˆë¡œìš´ ì‚¬ëŒê³¼ ìŠ¤ëª°í†¡ ğŸ‘‹", description: "íŒŒí‹°ë‚˜ ëª¨ì„ì—ì„œ ì²˜ìŒ ë§Œë‚œ ì‚¬ëŒê³¼ ê°€ë²¼ìš´ ëŒ€í™”ë¥¼ ë‚˜ëˆ•ë‹ˆë‹¤.", baseContext: "You are someone the user has just met at a social event. Engage in small talk, ask about their interests, job, etc., to help them practice initiating conversations with new people. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You have just met someone (the user) at a social event. Engage in small talk, share your interests, or ask about theirs concisely.", starters_userAsPrimary: ["Hi, I'm [Your Name]. Nice to meet you.", "So, what do you do for a living?", "Are you enjoying the event?"], starters_userAsOther: ["Hello! I don't think we've met. I'm [Your Name].", "Great event, isn't it?", "Hi there, mind if I join you?"] }, 
                    { id: "inviting_friend", title: "ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸° (ì‹ì‚¬, ì˜í™” ë“±) ğŸ“§", description: "ì¹œêµ¬ì—ê²Œ ì‹ì‚¬ë‚˜ ì˜í™” ê´€ëŒ ë“±ì„ ì œì•ˆí•˜ê³  ì•½ì†ì„ ì¡ìŠµë‹ˆë‹¤.", baseContext: "You are a friend of the user. The user wants to invite you out for a meal, movie, or another activity. Respond to their invitation, discuss plans, and confirm details. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You want to invite your friend (the user) for an activity. Make an invitation, suggest plans, and confirm details concisely.", starters_userAsPrimary: ["Are you free to grab dinner on Friday?", "I was wondering if you'd like to see a movie with me.", "Let's hang out sometime next week."], starters_userAsOther: ["Hey, what are you up to later?", "I was thinking of [activity], want to join?", "We should get together soon."] }, 
                    { id: "accepting_declining_invitation", title: "ì´ˆëŒ€ ìˆ˜ë½/ê±°ì ˆí•˜ê¸° âœ…âŒ", description: "ì¹œêµ¬ì˜ ì´ˆëŒ€ì— ëŒ€í•´ ìˆ˜ë½í•˜ê±°ë‚˜ ì •ì¤‘íˆ ê±°ì ˆí•˜ëŠ” ë°©ë²•ì„ ì—°ìŠµí•©ë‹ˆë‹¤.", baseContext: "You have invited the user to an event. The user will practice accepting or declining your invitation politely. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You have been invited to an event by the user. Practice accepting or declining the invitation politely and concisely.", starters_userAsPrimary: ["Thanks for inviting me! I'd love to come.", "That sounds great, but I'm afraid I have other plans.", "I appreciate the invitation, but I don't think I can make it."], starters_userAsOther: ["I'm having a get-together on Saturday, would you like to come?", "Want to catch a movie this weekend?", "I'm planning a [event], hope you can make it!"] } 
                ]}, 
                { category: "ë¬¸ì œ í•´ê²° ë° ìš”ì²­ (Problem Solving & Requests)", items: [ 
                    { id: "returning_item", title: "ë¬¼ê±´ í™˜ë¶ˆ/êµí™˜í•˜ê¸° ğŸ›ï¸", description: "ìƒì ì—ì„œ êµ¬ë§¤í•œ ë¬¼ê±´ì„ í™˜ë¶ˆí•˜ê±°ë‚˜ êµí™˜ ìš”ì²­í•˜ëŠ” ìƒí™©ì…ë‹ˆë‹¤.", baseContext: "You are a store clerk. The user wants to return or exchange an item they purchased. Ask for the reason, receipt, and guide them through the store's policy. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You want to return or exchange an item at a store. The user is the store clerk. Explain your reason and follow the process concisely.", starters_userAsPrimary: ["I'd like to return this item, please.", "Can I exchange this for a different size?", "There's a problem with this product I bought."], starters_userAsOther: ["Hi, how can I help you today?", "Do you have your receipt?", "What seems to be the problem with the item?"] }, 
                    { id: "tech_support", title: "ê¸°ìˆ  ì§€ì› ë¬¸ì˜í•˜ê¸° ğŸ’»", description: "ì œí’ˆ ì‚¬ìš© ì¤‘ ë¬¸ì œê°€ ë°œìƒí•˜ì—¬ ê¸°ìˆ  ì§€ì›íŒ€ì— ë¬¸ì˜í•©ë‹ˆë‹¤.", baseContext: "You are a technical support agent. The user is calling about an issue with a product or service. Help them troubleshoot the problem or escalate the issue. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are calling technical support for an issue with a product or service. The user is the support agent. Describe your problem and seek assistance concisely.", starters_userAsPrimary: ["I'm having trouble with my [product/service].", "My internet isn't working.", "Could you help me fix this error?"], starters_userAsOther: ["Thank you for calling Tech Support, my name is [Your Name]. How can I help you?", "Could you please describe the issue you're experiencing?", "Have you tried restarting your device?"] }, 
                    { id: "making_complaint", title: "ë¶ˆë§Œ ì œê¸°í•˜ê¸° (í˜¸í…”, ì‹ë‹¹ ë“±) ğŸ˜ ", description: "ì„œë¹„ìŠ¤ë‚˜ ì œí’ˆì— ëŒ€í•œ ë¶ˆë§Œì„ ì •ì¤‘í•˜ê²Œ í‘œí˜„í•©ë‹ˆë‹¤.", baseContext: "You are a manager or customer service representative. The user has a complaint about a service or product. Listen to their concerns and try to resolve the issue. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You have a complaint about a service or product. The user is the manager or customer service representative. Express your dissatisfaction politely and concisely.", starters_userAsPrimary: ["I'm afraid I have a complaint about...", "I'm not satisfied with the service I received.", "Could I speak to the manager, please?"], starters_userAsOther: ["I understand you have a concern. Please tell me what happened.", "I'm sorry to hear you're not satisfied. How can I make things right?", "Thank you for bringing this to my attention."] } 
                ]}, 
                { category: "ê±´ê°• ë° ì˜ë£Œ (Health & Medical)", items: [ 
                    { id: "hospital_visit", title: "ë³‘ì› ë°©ë¬¸ (ì¼ë°˜ ì§„ë£Œ) ğŸ¥", description: "ì˜ì‚¬ë‚˜ ê°„í˜¸ì‚¬ì—ê²Œ ì¦ìƒì„ ì„¤ëª…í•˜ê³  ì§„ë£Œ ê´€ë ¨ ëŒ€í™”ë¥¼ ë‚˜ëˆ•ë‹ˆë‹¤. AIëŠ” ì˜ë£Œì§„ ì—­í• ì„ í•©ë‹ˆë‹¤.", 
                      baseContext: "You are a doctor or nurse at a hospital. The user is a patient explaining their symptoms. Ask clarifying questions ONE AT A TIME. Keep responses concise (1-2 sentences) and professional. Do not ask many questions at once. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You are a patient visiting a doctor/nurse (the user). Describe your symptoms or ask for advice concisely. Respond to one question at a time.", 
                      starters_userAsPrimary: ["I'd like to see a doctor. I'm not feeling well.", "I have a persistent cough and a sore throat.", "I think I might have sprained my ankle."],
                      starters_userAsOther: ["Hello, what seems to be the problem today?", "Good morning. How can I help you?", "Please tell me what's bothering you."] }, 
                    { id: "dentist_visit", title: "ì¹˜ê³¼ ë°©ë¬¸ ğŸ¦·", description: "ì¹˜ê³¼ ì˜ì‚¬ë‚˜ ìœ„ìƒì‚¬ì—ê²Œ ì¹˜ì•„ ë¬¸ì œë¥¼ ì„¤ëª…í•˜ê±°ë‚˜ ì •ê¸° ê²€ì§„ ê´€ë ¨ ëŒ€í™”ë¥¼ í•©ë‹ˆë‹¤. AIëŠ” ì¹˜ê³¼ ì˜ë£Œì§„ ì—­í• ì„ í•©ë‹ˆë‹¤.", 
                      baseContext: "You are a dentist or dental hygienist. The user is a patient. Ask about their dental issue or needs. Keep questions focused and concise (1-2 sentences per turn). Ask ONE question at a time. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You are a patient at a dental clinic. The user is the dentist/hygienist. Explain your dental concern or reason for visit concisely. Respond to one question at a time.", 
                      starters_userAsPrimary: ["I have a toothache, and I'd like to make an appointment.", "I'm here for my 6-month check-up and cleaning.", "This tooth has been really sensitive to cold lately."],
                      starters_userAsOther: ["Hi, welcome to our dental clinic. How can I help you today?", "What brings you in to see us?", "Are you here for a check-up or a specific issue?"] } 
                ]},
                { category: "íŠ¹ë³„í•œ ìƒí™© (Special Occasions)", items: [ { id: "birthday_party", title: "ìƒì¼ íŒŒí‹° ëŒ€í™” ğŸ‰", description: "ìƒì¼ ì¶•í•˜ ë©”ì‹œì§€ë¥¼ ì „í•˜ê³  íŒŒí‹°ì—ì„œ ëŒ€í™”í•©ë‹ˆë‹¤.", baseContext: "You are a guest at a birthday party. The user is also a guest or the birthday person. Engage in light conversation, offer good wishes. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are at a birthday party. The user is another guest or the birthday person. Engage in conversation and offer good wishes concisely.", starters_userAsPrimary: ["Happy birthday!", "This is a great party!", "How are you enjoying your special day?"], starters_userAsOther: ["Thanks for coming to my party!", "So glad you could make it!", "Are you having a good time?"] }, { id: "congratulating_someone", title: "ì¶•í•˜ í‘œí˜„í•˜ê¸° ğŸ¥³", description: "ë‹¤ë¥¸ ì‚¬ëŒì˜ ì¢‹ì€ ì¼(ìŠ¹ì§„, ì¡¸ì—… ë“±)ì„ ì¶•í•˜í•©ë‹ˆë‹¤.", baseContext: "You are a friend or colleague of the user. The user wants to congratulate you or someone else on an achievement. Respond appropriately and concisely (1-2 sentences). Do not ask questions you've already received answers for.", baseContext_swapped:"You want to congratulate a friend or colleague (the user) on an achievement. Express your congratulations concisely.", starters_userAsPrimary: ["Congratulations on your promotion!", "That's fantastic news! Well done.", "I'm so happy for you!"], starters_userAsOther: ["Thank you so much!", "I really appreciate that.", "It means a lot to hear that from you."] } ] }, 
                { category: "ì‚¬ìš©ì ì„¤ì •", isCustomCategory: true, items: [ { id: "custom", title: "ì§ì ‘ ì…ë ¥ âœ¨", description: "ì—°ìŠµí•˜ê³  ì‹¶ì€ ìƒí™©ì´ë‚˜ ì£¼ì œë¥¼ ì•„ë˜ì— ìì„¸íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.", baseContext: "", baseContext_swapped: "", starters_userAsPrimary: ["Let's talk about [your topic].", "I want to practice discussing [your situation].", "Can we simulate a conversation about [your scenario]?"], starters_userAsOther: ["Okay, I'm ready for the custom scenario you described. What's my first line?", "I understand the custom scenario. How should I begin as the other person?", "Let's start the custom role-play. What's my role according to your description?"] } ] } 
            ];
            const findScenarioById = (id) => { for (const category of scenarioTree) { const found = category.items.find(item => item.id === id); if (found) return { ...found, categoryTitle: category.category }; } return null; };
            
            function initializeAppLogic() { const firebaseApp = initializeApp(firebaseConfig); auth = getAuth(firebaseApp); db = getFirestore(firebaseApp); onAuthStateChanged(auth, async (user) => { let finalUserId = null; if (user) { finalUserId = user.uid; } else { try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { const userCredential = await signInWithCustomToken(auth, __initial_auth_token); finalUserId = userCredential.user.uid; } else { const userCredential = await signInAnonymously(auth); finalUserId = userCredential.user.uid; } } catch (error) { console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error); } } if (finalUserId) { currentUserId = finalUserId; const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'info'); try { const docSnap = await getDoc(userProfileRef); let loadedScenarioData = findScenarioById("cafe"); let loadedFocusTopic = ''; let loadedCustomInput = ''; let loadedRoleIsUserPrimary = true; if (docSnap.exists()) { const profileData = docSnap.data(); const lastScenarioId = profileData.lastScenarioId; const foundScenarioFromDB = findScenarioById(lastScenarioId); if (foundScenarioFromDB) { loadedScenarioData = foundScenarioFromDB; if (foundScenarioFromDB.id === "custom" && profileData.lastCustomScenarioDetails) { loadedCustomInput = profileData.lastCustomScenarioDetails.description || ""; loadedScenarioData = { ...loadedScenarioData, title: profileData.lastCustomScenarioDetails.title || "ì‚¬ìš©ì ì„¤ì • ì—°ìŠµ" }; } else if (foundScenarioFromDB.id !== "custom") { loadedFocusTopic = profileData.lastFocusTopic || ''; } loadedRoleIsUserPrimary = profileData.lastRoleIsUserPrimary !== undefined ? profileData.lastRoleIsUserPrimary : true; } } currentScenario = loadedScenarioData || findScenarioById("cafe"); // ë°©ì–´ ì½”ë“œ
                currentFocusTopic = loadedFocusTopic; currentCustomScenarioInput = loadedCustomInput; userIsPlayingPrimaryRole = loadedRoleIsUserPrimary; updateScenarioDisplay(); focusTopicInput.value = currentFocusTopic; customScenarioInputElem.value = currentCustomScenarioInput; await setDoc(userProfileRef, { lastLogin: serverTimestamp(), lastScenarioId: currentScenario.id, lastRoleIsUserPrimary: userIsPlayingPrimaryRole, ...(currentScenario.id === "custom" && currentCustomScenarioInput ? { lastCustomScenarioDetails: { title: currentScenario.title, description: currentCustomScenarioInput } } : {}), ...(currentScenario.id !== "custom" ? { lastFocusTopic: currentFocusTopic } : {}) }, { merge: true }); } catch (error) { console.error("ì‚¬ìš©ì í”„ë¡œí•„ ì²˜ë¦¬ ì˜¤ë¥˜:", error); currentScenario = findScenarioById("cafe"); updateScenarioDisplay(); } } isAuthReady = true; }); }
            
            function getDynamicContext() { if (!currentScenario) return "You are a general English language tutor. No scenario selected."; let scenarioSpecificContext = ""; if (currentScenario.id === "custom") { if (!currentCustomScenarioInput.trim()) return "You are a general English language tutor. The user hasn't specified a topic yet. Ask what they'd like to talk about. Keep responses concise and ask one question at a time."; if (!userIsPlayingPrimaryRole) { scenarioSpecificContext = `ROLE SWAP: You are now the conversation partner based on the user's custom scenario: "${currentCustomScenarioInput}". The human user will act as your AI tutor or guide. Please respond naturally based on the scenario, keeping your responses concise (1-2 sentences) and asking only one question at a time if needed. Do not ask questions you've already received answers for.`; } else { scenarioSpecificContext = `You are a friendly and helpful English language tutor. The user wants to practice a conversation based on their custom scenario: "${currentCustomScenarioInput}". Act as a partner for this topic, ask relevant questions, and help with their English. Keep responses concise (1-2 sentences) and ask only one question at a time if needed. Do not ask questions you've already received answers for.`; } } else { if (userIsPlayingPrimaryRole) { scenarioSpecificContext = currentScenario.baseContext; } else { scenarioSpecificContext = currentScenario.baseContext_swapped || `ROLE SWAP! You are now taking on the role typically played by the AI in the "${currentScenario.title}" scenario. For example, if the user was the customer at a cafe, you are now the customer. The human user is playing the other part (e.g., barista). Please initiate or respond accordingly, keeping your responses concise (1-2 sentences) and asking only one question at a time if needed. Do not ask questions you've already received answers for.`; } } const focusTopicInstruction = (userIsPlayingPrimaryRole && currentFocusTopic && currentScenario.id !== "custom") ? `\n\nThe user also wants to focus on: "${currentFocusTopic}". Try to incorporate this into the conversation.` : ''; return `${scenarioSpecificContext}${focusTopicInstruction}`; }
            async function callGeminiAPI(prompt) { const payload = { message: prompt }; const API_ENDPOINT = "https://magenta-morning-find.glitch.me/generate"; const apiUrl = API_ENDPOINT; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { let errorDetails = `ì„œë²„ ì‘ë‹µ: ${response.statusText || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`; try { const errorData = await response.json(); errorDetails = errorData.error || errorData.message || (typeof errorData === 'object' ? JSON.stringify(errorData) : String(errorData)); if (!errorDetails || errorDetails === '{}' || errorDetails.trim() === "") { errorDetails = `ì„œë²„ ì‘ë‹µ: ${response.statusText || 'ì˜¤ë¥˜ ë‚´ìš© ì—†ìŒ'}`; } } catch (jsonError) { console.warn("API ì˜¤ë¥˜ ì‘ë‹µì´ JSONì´ ì•„ë‹ˆë¯€ë¡œ í…ìŠ¤íŠ¸ë¡œ ì½ê¸°ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.", jsonError); try { const errorText = await response.text(); errorDetails = errorText.trim() || `ì„œë²„ ì‘ë‹µ: ${response.statusText || 'ì˜¤ë¥˜ ë‚´ìš© ì—†ìŒ'}`; } catch (textError) { console.error("API ì˜¤ë¥˜ ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ì½ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", textError); errorDetails = `ì„œë²„ ì‘ë‹µ: ${response.statusText || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}, ì‘ë‹µ ë³¸ë¬¸ ì½ê¸° ì‹¤íŒ¨`; } } const errorMsg = `API ìš”ì²­ ì‹¤íŒ¨ (${response.status}): ${errorDetails}`; console.error("API Error Details:", errorDetails); throw new Error(errorMsg); } const result = await response.json(); if (result.text) { return result.text; } else if (result.generated_text) { return result.generated_text; } else if (result.reply) { return result.reply; } else if (typeof result === 'string') { return result; } else if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) { console.warn("Gemini API í˜•ì‹ì˜ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤. Glitch ì—”ë“œí¬ì¸íŠ¸ê°€ ì´ í˜•ì‹ì„ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."); return result.candidates[0].content.parts[0].text; } else { console.error("API ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ê±°ë‚˜, ì˜ˆìƒì¹˜ ëª»í•œ êµ¬ì¡°ì…ë‹ˆë‹¤:", result); throw new Error('AIë¡œë¶€í„° ìœ íš¨í•œ í…ìŠ¤íŠ¸ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); } } catch (error) { console.error("API í˜¸ì¶œ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", error); throw error; } }

            function updateScenarioDisplay(isConversationStarting = false) { if (!currentScenario) return; const displayTitle = currentScenario.id === 'custom' ? (currentCustomScenarioInput ? `ì‚¬ìš©ì ì„¤ì •: ${currentCustomScenarioInput.substring(0,10)}...` : "ì‚¬ìš©ì ì„¤ì •") : (currentScenario.categoryTitle ? `${currentScenario.title.split(" ")[0]}` : currentScenario.title.split(" ")[0]); currentScenarioDisplay.textContent = displayTitle; headerTitle.title = currentScenario.title; scenarioTitleElem.textContent = currentScenario.id === "custom" ? (currentCustomScenarioInput ? `ì£¼ì œ: ${currentCustomScenarioInput.substring(0,40)}...` : "ì‚¬ìš©ì ì„¤ì • ì‹œë‚˜ë¦¬ì˜¤") : currentScenario.title; const elementsToHide = document.querySelectorAll('.hide-after-conversation-start'); if (isConversationStarting) { elementsToHide.forEach(el => el.classList.add('hidden')); scenarioDescriptionArea.classList.remove('pb-4', 'sm:pb-5'); scenarioTitleElem.classList.remove('mb-1.5'); scenarioTitleElem.classList.add('mb-0'); } else { elementsToHide.forEach(el => el.classList.remove('hidden')); scenarioDescriptionElem.textContent = currentScenario.id === "custom" ? scenarioTree.find(c=>c.isCustomCategory).items[0].description : currentScenario.description; starterPhrasesElem.innerHTML = ''; const starters = userIsPlayingPrimaryRole ? (currentScenario.starters_userAsPrimary || currentScenario.starters) : currentScenario.starters_userAsOther; if (starters && starters.length > 0) { starterPhrasesContainer.classList.remove('hidden'); starters.forEach(starter => { const button = document.createElement('button'); button.className = "text-xs bg-sky-100 hover:bg-sky-200 text-sky-700 px-2 py-1 rounded-md shadow-sm transition-colors"; button.textContent = `"${starter}"`; button.onclick = () => { userInputElem.value = starter; }; starterPhrasesElem.appendChild(button); }); } else { starterPhrasesContainer.classList.add('hidden'); } if (currentScenario.id === "custom") { customScenarioGroup.classList.remove('hidden'); focusTopicGroup.classList.add('hidden'); } else { customScenarioGroup.classList.add('hidden'); focusTopicGroup.classList.remove('hidden'); } scenarioDescriptionArea.classList.remove('hidden'); scenarioDescriptionArea.classList.add('pb-4', 'sm:pb-5'); scenarioTitleElem.classList.add('mb-1.5'); scenarioTitleElem.classList.remove('mb-0'); } }
            
            function renderScenarioPicker() { scenarioDropdown.innerHTML = ''; scenarioTree.forEach(category => { const categoryDiv = document.createElement('div'); const categoryHeader = document.createElement('div'); categoryHeader.className = `flex justify-between items-center p-1.5 sm:p-2 hover:bg-sky-100 cursor-pointer text-slate-800 font-medium text-xs sm:text-sm category-header`; if (category.isCustomCategory && currentScenario && currentScenario.id === category.items[0].id) { categoryHeader.classList.add('scenario-picker-item-selected'); } const categoryTitleSpan = document.createElement('span'); categoryTitleSpan.textContent = category.category; categoryHeader.appendChild(categoryTitleSpan); if (!category.isCustomCategory) { const chevron = document.createElement('span'); const svgNS = "http://www.w3.org/2000/svg"; const svgEl = document.createElementNS(svgNS, "svg"); svgEl.setAttribute("viewBox", "0 0 20 20"); svgEl.setAttribute("fill", "currentColor"); svgEl.classList.add("w-5", "h-5", "transform", "transition-transform"); if (expandedCategories[category.category]) { svgEl.classList.add("rotate-90"); } else { svgEl.classList.remove("rotate-90"); } const pathEl = document.createElementNS(svgNS, "path"); pathEl.setAttribute("fill-rule", "evenodd"); pathEl.setAttribute("d", "M7.21 14.77a.75.75 0 0 1 .02-1.06L11.168 10 7.23 6.29a.75.75 0 1 1 1.04-1.08l4.5 4.25a.75.75 0 0 1 0 1.08l-4.5 4.25a.75.75 0 0 1-1.06-.02Z"); pathEl.setAttribute("clip-rule", "evenodd"); svgEl.appendChild(pathEl); chevron.appendChild(svgEl); categoryHeader.appendChild(chevron); } categoryHeader.onclick = (event) => { event.stopPropagation(); if (category.isCustomCategory) { handleScenarioSelect(category.items[0]); } else { expandedCategories[category.category] = !expandedCategories[category.category]; renderScenarioPicker(); } }; categoryDiv.appendChild(categoryHeader); if (expandedCategories[category.category] && !category.isCustomCategory) { const itemsDiv = document.createElement('div'); itemsDiv.className = "pl-3 border-l border-sky-200"; category.items.forEach(item => { const itemDiv = document.createElement('div'); itemDiv.className = `py-1 px-1.5 sm:py-1.5 sm:px-2 text-xs hover:bg-sky-50 cursor-pointer text-slate-600 scenario-picker-item`; if (currentScenario && currentScenario.id === item.id) { itemDiv.classList.add('scenario-picker-item-selected'); } itemDiv.textContent = item.title; itemDiv.onclick = (event) => { event.stopPropagation(); handleScenarioSelect(item); }; itemsDiv.appendChild(itemDiv); }); categoryDiv.appendChild(itemsDiv); } scenarioDropdown.appendChild(categoryDiv); }); }
            function toggleScenarioPicker() { showScenarioPicker = !showScenarioPicker; if (showScenarioPicker) { renderScenarioPicker(); scenarioDropdown.classList.remove('hidden'); scenarioDropdown.classList.add('fade-in'); } else { scenarioDropdown.classList.add('hidden'); expandedCategories = {}; } }
            function handleScenarioSelect(scenarioItem) { if (isLoading) { alert("AIê°€ ì‘ë‹µ ì¤‘ì¼ ë•ŒëŠ” ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; } const fullScenarioDetails = findScenarioById(scenarioItem.id); currentScenario = fullScenarioDetails; currentMessages = []; userInputElem.value = ''; suggestedRepliesList.innerHTML = ''; suggestedRepliesContainer.classList.add('hidden'); closeAnalysisModal(); userIsPlayingPrimaryRole = true; if (scenarioItem.id !== "custom") { currentCustomScenarioInput = ''; customScenarioInputElem.value = ''; } else { currentFocusTopic = ''; focusTopicInput.value = ''; } updateScenarioDisplay(false); renderMessages(); toggleScenarioPicker(); }
            function handleNewConversation() { if (isLoading) { alert("AIê°€ ì‘ë‹µ ì¤‘ì¼ ë•ŒëŠ” ìƒˆ ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; } currentMessages = []; userInputElem.value = ''; suggestedRepliesList.innerHTML = ''; suggestedRepliesContainer.classList.add('hidden'); closeAnalysisModal(); userIsPlayingPrimaryRole = true; updateScenarioDisplay(false); renderMessages(); const scenarioTitleForAlert = currentScenario.id === 'custom' ? (currentCustomScenarioInput || 'ì‚¬ìš©ì ì„¤ì •') : currentScenario.title; alert(`"${scenarioTitleForAlert}" ì‹œë‚˜ë¦¬ì˜¤ë¡œ ìƒˆ ëŒ€í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`); }
            
            function simpleMarkdownToHtml(text) { if (!text) return ''; let html = text; html = html.replace(/\*\*(.*?)\*\*|__(.*?)__/g, '<strong>$1$2</strong>'); html = html.replace(/\*(.*?)\*|_(.*?)_/g, '<em>$1$2</em>'); html = html.replace(/~~(.*?)~~/g, '<del>$1</del>'); html = html.replace(/^\s*[\*\-\+]\s+(.*)/gm, '<li>$1</li>'); html = html.replace(/<\/li>\s*<li>/g, '</li><li>'); if (html.includes('<li>')) { const listItems = html.match(/<li>.*?<\/li>/g); if (listItems) { html = `<ul>${listItems.join('')}</ul>`; } } html = html.replace(/\n/g, '<br />'); html = html.replace(/<li><br \/>/g, '<li>'); html = html.replace(/<br \/><\/li>/g, '</li>'); html = html.replace(/<br \/>\s*<ul>/g, '<ul>'); html = html.replace(/<\/ul>\s*<br \/>/g, '</ul>'); return html; }

            function renderMessages() { messagesContainer.innerHTML = ''; currentMessages.forEach(msg => { const messageWrapper = document.createElement('div'); messageWrapper.className = `flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`; const messageBubble = document.createElement('div'); messageBubble.className = `max-w-3/4 sm:max-w-md lg:max-w-lg px-3 py-2 sm:px-4 sm:py-2.5 rounded-2xl shadow ${ msg.sender === 'user' ? 'user-bubble text-white rounded-br-none' : 'ai-bubble text-slate-800 rounded-bl-none' }`; messageBubble.innerHTML = simpleMarkdownToHtml(msg.text); messageWrapper.appendChild(messageBubble); messagesContainer.appendChild(messageWrapper); }); messagesContainer.scrollTop = messagesContainer.scrollHeight; }
            function setLoadingState(buttonId, textWhileLoading, isLoadingFlag) { const button = document.getElementById(buttonId); const buttonTextSpan = document.getElementById(`${buttonId}Text`); if (button && buttonTextSpan) { button.disabled = isLoadingFlag; buttonTextSpan.textContent = isLoadingFlag ? textWhileLoading : (buttonId === 'suggestRepliesButton' ? 'AI ì‘ë‹µ ì œì•ˆ' : 'ë‚´ ë¬¸ì¥ ë¶„ì„'); } }
            
            async function handleSendMessage() { 
                if (userInputElem.value.trim() === '' || isLoading) return; 
                if (currentScenario.id === "custom" && currentCustomScenarioInput.trim() === '' && currentMessages.length === 0) { 
                    alert("ì‚¬ìš©ì ì •ì˜ ì‹œë‚˜ë¦¬ì˜¤ ë‚´ìš©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”."); 
                    return; 
                } 
                const newUserMessage = { sender: 'user', text: userInputElem.value.trim(), timestamp: new Date() }; 
                currentMessages.push(newUserMessage); 
                renderMessages(); 
                const currentInputForAPI = userInputElem.value; 
                userInputElem.value = ''; 
                isLoading = true; 
                sendMessageButton.disabled = true; 
                sendMessageButton.innerHTML = `<svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"> <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path> </svg>`; 
                
                updateScenarioDisplay(true); 
                
                suggestedRepliesList.innerHTML = ''; 
                suggestedRepliesContainer.classList.add('hidden'); 
                closeAnalysisModal(); 
                if (db && currentUserId) { try { await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/conversations/${currentScenario.id === "custom" ? `custom_${currentCustomScenarioInput.substring(0,10).replace(/\s/g, '_')}` : currentScenario.id}/messages`), { ...newUserMessage, timestamp: serverTimestamp() }); } catch (error) { console.error("ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥ ì˜¤ë¥˜:", error); } } 
                
                const contextForAI = getDynamicContext();
                // ì´ì „ ëŒ€í™” ë‚´ìš©ì„ í¬í•¨í•˜ì—¬ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
                let conversationHistoryForAPI = "Previous conversation:\n";
                currentMessages.slice(Math.max(0, currentMessages.length - 7), -1).forEach(msg => { // ìµœê·¼ 6ê°œ ë©”ì‹œì§€ (3í„´)
                    conversationHistoryForAPI += `${msg.sender === 'user' ? 'User' : 'AI'}: ${msg.text}\n`;
                });

                const promptForAI = `System Instruction: ${contextForAI}\n\n${currentMessages.length > 1 ? conversationHistoryForAPI : ''}User: ${currentInputForAPI}`;


                try { 
                    const aiResponseText = await callGeminiAPI(promptForAI); 
                    const newAiMessage = { sender: 'ai', text: aiResponseText, timestamp: new Date() }; 
                    currentMessages.push(newAiMessage); 
                    renderMessages(); 
                    if (db && currentUserId) { try { await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/conversations/${currentScenario.id === "custom" ? `custom_${currentCustomScenarioInput.substring(0,10).replace(/\s/g, '_')}` : currentScenario.id}/messages`), { ...newAiMessage, timestamp: serverTimestamp() }); } catch (error) { console.error("AI ë©”ì‹œì§€ ì €ì¥ ì˜¤ë¥˜:", error); } } 
                } catch (error) { 
                    currentMessages.push({ sender: 'ai', text: `AI ì‘ë‹µ ì˜¤ë¥˜: ${error.message}`, timestamp: new Date() }); 
                    renderMessages(); 
                } finally { 
                    isLoading = false; 
                    sendMessageButton.disabled = false; 
                    sendMessageButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"> <path d="M3.5 2.75a.75.75 0 00-1.061.645l1.906 11.438a.75.75 0 001.412-.001L7.25 9.086l5.438-4.078a.75.75 0 00-.816-1.299L4.06 7.354 3.5 2.75zM2.75 16.5a.75.75 0 001.061.645l12.626-7.575a.75.75 0 000-1.29l-12.626-7.575A.75.75 0 002.75 1.5v15z" /> </svg>`; 
                } 
            }
            async function handleSuggestRepliesLogic() { if (isLoadingSuggestions || currentMessages.length === 0) return; isLoadingSuggestions = true; setLoadingState('suggestRepliesButton', 'ë¡œë”©ì¤‘...', true); closeAnalysisModal(); try { const lastMessage = currentMessages[currentMessages.length - 1]; if (lastMessage.sender !== 'ai') { alert("AIì˜ ì‘ë‹µ í›„ì—ë§Œ ì œì•ˆì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); isLoadingSuggestions = false; setLoadingState('suggestRepliesButton', '', false); return; } const scenarioTitleForPrompt = currentScenario.id === "custom" ? (currentCustomScenarioInput || "ì‚¬ìš©ì ì •ì˜ ì£¼ì œ") : currentScenario.title; const focusTopicForPrompt = currentScenario.id === "custom" ? "" : (currentFocusTopic ? `The user is also focusing on "${currentFocusTopic}".` : ''); const prompt = `Based on the AI Tutor's last message: "${lastMessage.text}", provide ONLY 3 diverse and natural-sounding replies (short to medium length) that the user (who is learning English) could say next in the "${scenarioTitleForPrompt}" scenario. ${focusTopicForPrompt} Format them strictly as a numbered list, starting each item with a number and a period (e.g., 1. Suggestion one.). Do not include any introductory or explanatory text before or after the list. Consider the current role of the user: ${userIsPlayingPrimaryRole ? 'they are the primary actor in the scenario (e.g., customer, patient)' : 'they are playing the AI tutor/staff role'}.`; const suggestionsText = await callGeminiAPI(prompt); let parsedSuggestions = suggestionsText.split('\n').map(s => s.trim()).filter(s => s.length > 0 && /^\d+\.\s*.+/.test(s)).map(s => s.replace(/^\d+\.\s*/, '').trim()).filter(s => s.length > 0 && !s.toLowerCase().startsWith("here are") && !s.toLowerCase().includes("suggestion for")); suggestedRepliesList.innerHTML = ''; if (parsedSuggestions.length > 0) { parsedSuggestions.slice(0,3).forEach(reply => { const li = document.createElement('li'); li.className = "text-xs sm:text-sm text-sky-700 hover:text-sky-800 cursor-pointer p-1.5 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"; li.textContent = `"${reply}"`; li.onclick = () => { userInputElem.value = reply; suggestedRepliesList.innerHTML = ''; suggestedRepliesContainer.classList.add('hidden'); }; suggestedRepliesList.appendChild(li); }); suggestedRepliesContainer.classList.remove('hidden'); suggestedRepliesContainer.classList.add('fade-in'); } else { suggestedRepliesList.innerHTML = `<li class="text-slate-500">ì ì ˆí•œ ì œì•ˆì„ ì°¾ì§€ ëª»í–ˆì–´ìš”.</li>`; suggestedRepliesContainer.classList.remove('hidden');} } catch (error) { suggestedRepliesList.innerHTML = `<li class="text-red-500">ì œì•ˆ ìƒì„± ì˜¤ë¥˜: ${error.message}</li>`; suggestedRepliesContainer.classList.remove('hidden'); } finally { isLoadingSuggestions = false; setLoadingState('suggestRepliesButton', '', false); } }
            async function handleAnalyzeSentenceLogic() { if (isLoadingAnalysis) return; const userMessages = currentMessages.filter(msg => msg.sender === 'user'); if (userMessages.length === 0) { alert("ë¶„ì„í•  ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤."); return; } isLoadingAnalysis = true; setLoadingState('analyzeSentenceButton', 'ë¶„ì„ì¤‘...', true); suggestedRepliesList.innerHTML = ''; suggestedRepliesContainer.classList.add('hidden'); closeAnalysisModal(); try { const lastUserMessage = userMessages[userMessages.length - 1]; const scenarioTitleForPrompt = currentScenario.id === "custom" ? (currentCustomScenarioInput || "ì‚¬ìš©ì ì •ì˜ ì£¼ì œ") : currentScenario.title; const focusTopicForPrompt = currentScenario.id === "custom" ? "" : (currentFocusTopic ? `They are focusing on "${currentFocusTopic}".` : ''); const analysisPrompt = `The user (learning English) said: "${lastUserMessage.text}" in the context of "${scenarioTitleForPrompt}" scenario. ${focusTopicForPrompt} Provide a structured analysis in English: **â­ Overall Impression:** (Brief positive comment or general feel) **ğŸ‘ Strengths:** (What was good about the sentence) **ğŸ’¡ Areas for Improvement:** **Grammar:** (Specific errors & corrections. If none, say "Grammar is good.") **Vocabulary:** (Word choice suggestions, better alternatives. If good, say "Vocabulary is appropriate.") **Naturalness/Fluency:** (Tips to sound more natural. If good, say "Sounds natural.") **âœ¨ Suggested Revision (if any):** (Offer a revised version of the sentence if significant improvements can be made) Keep feedback constructive and easy for an English learner. After the English analysis, provide a concise summary of the feedback in Korean, under a heading "ğŸ‡°ğŸ‡· í•œêµ­ì–´ ìš”ì•½:". This summary should highlight the main points of the feedback for a beginner to understand easily.`; const combinedAnalysisText = await callGeminiAPI(analysisPrompt); const koreanSummaryMarker = "ğŸ‡°ğŸ‡· í•œêµ­ì–´ ìš”ì•½:"; const koreanSummaryIndex = combinedAnalysisText.indexOf(koreanSummaryMarker); let engAnalysis = ""; let korSummary = "í•œêµ­ì–´ ìš”ì•½ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."; if (koreanSummaryIndex !== -1) { engAnalysis = combinedAnalysisText.substring(0, koreanSummaryIndex).trim(); korSummary = combinedAnalysisText.substring(koreanSummaryIndex + koreanSummaryMarker.length).trim(); } else { engAnalysis = combinedAnalysisText.trim(); } englishAnalysisResultDiv.innerHTML = simpleMarkdownToHtml(engAnalysis); koreanAnalysisResultDiv.innerHTML = simpleMarkdownToHtml(korSummary); analysisModal.classList.remove('hidden'); analysisModal.classList.add('fade-in'); } catch (error) { englishAnalysisResultDiv.textContent = `ë¶„ì„ ì˜¤ë¥˜: ${error.message}`; koreanAnalysisResultDiv.textContent = ""; analysisModal.classList.remove('hidden'); analysisModal.classList.add('fade-in'); } finally { isLoadingAnalysis = false; setLoadingState('analyzeSentenceButton', '', false); } }
            
            function handleRoleSwapClick() { 
                userIsPlayingPrimaryRole = !userIsPlayingPrimaryRole; 
                currentMessages = []; 
                renderMessages(); 
                userInputElem.value = ''; 
                updateScenarioDisplay(false); 
                const currentRoleDescription = userIsPlayingPrimaryRole ? 
                    (currentScenario.id === 'custom' ? 'ì§ì ‘ ì…ë ¥í•œ ìƒí™©ì˜ ì£¼ë„ì ì¸ ì—­í• ' : `"${currentScenario.title}" ìƒí™©ì˜ ì£¼ë„ì ì¸ ì—­í•  (ì˜ˆ: ì†ë‹˜, í™˜ì)`) :
                    (currentScenario.id === 'custom' ? 'ì§ì ‘ ì…ë ¥í•œ ìƒí™©ì˜ AI ì—­í• ' : `"${currentScenario.title}" ìƒí™©ì˜ AI ì—­í•  (ì˜ˆ: ì§ì›, ì˜ì‚¬)`);
                
                alert(`ì—­í• ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ë‹¹ì‹ ì€ "${currentRoleDescription}"ì…ë‹ˆë‹¤. AIê°€ ë¨¼ì € ë§ì„ ê±¸ë„ë¡ í•˜ê±°ë‚˜, ìƒˆë¡œìš´ ì—­í• ì— ë§ì¶° ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.`);
                
                if (!userIsPlayingPrimaryRole && currentMessages.length === 0 && currentScenario.id !== 'custom') {
                    // ì—­í•  ë³€ê²½ í›„ AIê°€ ë¨¼ì € ë§í•˜ë„ë¡ ìœ ë„í•˜ëŠ” ì˜ˆì‹œ (ì„ íƒì )
                    // const aiGreeting = currentScenario.starters_userAsOther && currentScenario.starters_userAsOther.length > 0 ? currentScenario.starters_userAsOther[0] : "Hello! How can I assist you?";
                    // currentMessages.push({ sender: 'ai', text: aiGreeting, timestamp: new Date() });
                    // renderMessages();
                }
            }

            function closeAnalysisModal() {
                analysisModal.classList.add('hidden');
                englishAnalysisResultDiv.innerHTML = '';
                koreanAnalysisResultDiv.innerHTML = '';
            }

            function closeGuideModalAndSavePreference() {
                guideModal.classList.add('hidden');
                localStorage.setItem(`guideShown_${appId}`, 'true');
            }

            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
            scenarioPickerButton.addEventListener('click', toggleScenarioPicker);
            newConversationButton.addEventListener('click', handleNewConversation);
            helpButton.addEventListener('click', () => { 
                guideModal.classList.remove('hidden');
                guideModal.classList.add('fade-in');
            });
            closeGuideModalButton.addEventListener('click', closeGuideModalAndSavePreference);
            confirmGuideModalButton.addEventListener('click', closeGuideModalAndSavePreference);

            sendMessageButton.addEventListener('click', handleSendMessage);
            userInputElem.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !isLoading) handleSendMessage(); });
            suggestRepliesButton.addEventListener('click', handleSuggestRepliesLogic);
            analyzeSentenceButton.addEventListener('click', handleAnalyzeSentenceLogic);
            roleSwapButton.addEventListener('click', handleRoleSwapClick);
            
            closeAnalysisModalButtonFromAnalysis.addEventListener('click', closeAnalysisModal);
            confirmAnalysisModalButtonFromAnalysis.addEventListener('click', closeAnalysisModal);
            
            focusTopicInput.addEventListener('change', (e) => { currentFocusTopic = e.target.value; });
            customScenarioInputElem.addEventListener('change', (e) => { currentCustomScenarioInput = e.target.value; updateScenarioDisplay(); });

            document.addEventListener('click', (event) => { 
                if (scenarioPickerButton && !scenarioPickerButton.contains(event.target) && scenarioDropdown && !scenarioDropdown.contains(event.target) && showScenarioPicker) {
                    toggleScenarioPicker();
                }
                if (analysisModalContent && !analysisModalContent.contains(event.target) && analysisModal && !analysisModal.classList.contains('hidden') && analyzeSentenceButton && !analyzeSentenceButton.contains(event.target)) {
                    if (suggestRepliesButton && !suggestRepliesButton.contains(event.target)) { 
                         closeAnalysisModal();
                    }
                }
                if (guideModalContent && !guideModalContent.contains(event.target) && guideModal && !guideModal.classList.contains('hidden') && helpButton && !helpButton.contains(event.target)) {
                    closeGuideModalAndSavePreference();
                }
            });

            // --- ì´ˆê¸°í™” ---
            initializeAppLogic();
        }); 
    </script>
</body>
</html>
