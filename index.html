<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeakUp AI - AI 영어 회화 튜터</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f7fafc; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-glow-blue { box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .btn-glow-amber { box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }
        .btn-glow-teal { box-shadow: 0 0 15px rgba(20, 184, 166, 0.4); }
        .btn-glow-indigo { box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }

        .gradient-bg { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
        .header-bg { background-color: #2c5282; }
        .chat-bg { background-color: #f8fafc; }
        .user-bubble { background-color: #3b82f6; }
        .ai-bubble { background-color: #e5e7eb; }
        .input-area-bg { background-color: #ffffff; }
        .modal-bg-overlay { background-color: rgba(0, 0, 0, 0.6); }
        .scenario-picker-item:hover { background-color: #eff6ff; }
        .scenario-picker-item-selected { background-color: #dbeafe; font-weight: 600; color: #1d4ed8; }
        .category-header:hover { background-color: #f0f9ff; }
        .ai-bubble ul { list-style-type: disc; padding-left: 20px; margin-top: 8px; margin-bottom: 8px; }
        .ai-bubble li { margin-bottom: 4px; }
        .compact-button {
            padding-top: 0.5rem; 
            padding-bottom: 0.5rem; 
            padding-left: 0.5rem; 
            padding-right: 0.5rem; 
            font-size: 0.8rem; 
            line-height: 1.1rem;
            min-height: 38px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            text-align: center;
        }
        .compact-button svg {
            margin-right: 0.25rem;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen gradient-bg p-2 sm:p-4">

    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col" style="height: calc(100vh - 30px); max-height: 800px;">
        <header class="header-bg text-white p-4 sm:p-5 rounded-t-2xl flex items-center justify-between relative shadow-md">
            <div class="flex items-center">
                <div class="relative" id="scenarioPickerContainer">
                    <button id="scenarioPickerButton" class="flex items-center text-sm sm:text-base bg-sky-700 hover:bg-sky-600 px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-400">
                        <span id="currentScenarioDisplay">시나리오</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 ml-1.5 opacity-80"> <path fillRule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clipRule="evenodd" /> </svg>
                    </button>
                    <div id="scenarioDropdown" class="hidden absolute left-0 mt-2 w-72 sm:w-80 bg-white rounded-lg shadow-xl z-20 border border-slate-200 max-h-96 overflow-y-auto custom-scrollbar fade-in">
                        </div>
                </div>
            </div>
            <h1 id="headerTitle" class="text-xl sm:text-2xl font-semibold text-center absolute left-1/2 transform -translate-x-1/2 truncate max-w-[40%] sm:max-w-[50%]" title="SpeakUp AI">SpeakUp AI</h1> 
            <div class="flex items-center space-x-2">
                <button id="helpButton" title="도움말 보기" class="text-sm sm:text-base bg-sky-700 hover:bg-sky-600 p-2 sm:p-2.5 rounded-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-400">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                    </svg>
                </button>
                <button id="newConversationButton" title="새 대화 시작" class="text-sm sm:text-base bg-sky-700 hover:bg-sky-600 p-2 sm:p-2.5 rounded-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-400">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-5 h-5"> <path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /> </svg>
                </button>
            </div>
        </header>

        <div id="scenarioDescriptionArea" class="p-4 sm:p-5 border-b border-slate-200 bg-slate-50">
            <h2 id="scenarioTitle" class="text-lg sm:text-xl font-semibold text-sky-700 mb-1.5">시나리오 제목</h2>
            <p id="scenarioDescription" class="text-sm text-slate-600 mb-3 leading-relaxed hide-after-conversation-start">시나리오 설명</p>
            <div id="starterPhrasesContainer" class="mt-2 mb-3 hidden hide-after-conversation-start">
                <p class="text-xs font-semibold text-sky-600 mb-1.5">이렇게 시작해 보세요:</p>
                <div id="starterPhrases" class="flex flex-wrap gap-2">
                    </div>
            </div>
            <div id="focusTopicGroup" class="hide-after-conversation-start">
                 <input type="text" id="focusTopicInput" placeholder="집중 연습 주제 (선택 사항)" class="w-full p-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow"/>
            </div>
            <div id="customScenarioGroup" class="hidden hide-after-conversation-start">
                <textarea id="customScenarioInput" placeholder="연습하고 싶은 상황이나 대화 주제를 자세히 입력해주세요..." class="w-full p-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow" rows="3"></textarea>
            </div>
        </div>

        <div id="messagesContainer" class="flex-grow p-4 sm:p-5 overflow-y-auto chat-bg space-y-4 custom-scrollbar">
            </div>
        
        <div class="p-4 sm:p-5 border-t border-slate-200 input-area-bg">
            <div class="flex items-center space-x-3 mb-3"> 
                <input type="text" id="userInput" placeholder="메시지를 입력하세요..." class="flex-grow p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow text-base shadow-sm"/>
                <button id="sendMessageButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold p-3 rounded-xl transition-all duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center shadow-md hover:shadow-lg btn-glow-blue focus:outline-none focus:ring-2 focus:ring-blue-300">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"> <path d="M3.5 2.75a.75.75 0 00-1.061.645l1.906 11.438a.75.75 0 001.412-.001L7.25 9.086l5.438-4.078a.75.75 0 00-.816-1.299L4.06 7.354 3.5 2.75zM2.75 16.5a.75.75 0 001.061.645l12.626-7.575a.75.75 0 000-1.29l-12.626-7.575A.75.75 0 002.75 1.5v15z" /> </svg>
                </button>
            </div>
            
            <div id="suggestedRepliesContainer" class="mb-2.5 p-2.5 bg-sky-50 rounded-lg hidden shadow fade-in">
                <h4 class="text-xs font-semibold text-sky-700 mb-1.5">AI 응답 제안:</h4>
                <ul id="suggestedRepliesList" class="space-y-1.5">
                    </ul>
            </div>

            <div class="flex space-x-2"> 
                <button id="suggestRepliesButton" class="compact-button bg-amber-400 hover:bg-amber-500 text-amber-900 font-semibold rounded-lg transition-all duration-150 ease-in-out disabled:opacity-60 flex items-center justify-center shadow hover:shadow-md btn-secondary-glow focus:outline-none focus:ring-2 focus:ring-amber-300 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"> <path fillRule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.39-3.423 3.352c-.772.753-.235 2.047.788 2.225l4.21.728 1.948 4.24c.322.772 1.416.772 1.737 0l1.947-4.24 4.21-.728c1.023-.178 1.56-1.472.788-2.225l-3.423-3.352-4.753-.39-1.83-4.401zM12.267 8.197L10 12.488l-2.267-4.291-4.573-.374 3.29-3.218-1.043-4.493 4.065 1.956L10 0l2.528 1.978 4.065-1.956-1.043 4.493 3.29 3.218-4.573.374z" clipRule="evenodd" /> </svg> 
                    <span id="suggestRepliesButtonText">응답 제안</span>
                </button>
                <button id="analyzeSentenceButton" class="compact-button bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded-lg transition-all duration-150 ease-in-out disabled:opacity-60 flex items-center justify-center shadow-md hover:shadow-lg btn-tertiary-glow focus:outline-none focus:ring-2 focus:ring-teal-300 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"> <path fillRule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.39-3.423 3.352c-.772.753-.235 2.047.788 2.225l4.21.728 1.948 4.24c.322.772 1.416.772 1.737 0l1.947-4.24 4.21-.728c1.023-.178 1.56-1.472.788-2.225l-3.423-3.352-4.753-.39-1.83-4.401zM12.267 8.197L10 12.488l-2.267-4.291-4.573-.374 3.29-3.218-1.043-4.493 4.065 1.956L10 0l2.528 1.978 4.065-1.956-1.043 4.493 3.29 3.218-4.573.374z" clipRule="evenodd" /> </svg> 
                    <span id="analyzeSentenceButtonText">문장 분석</span>
                </button>
                <button id="roleSwapButton" class="compact-button bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg transition-all duration-150 ease-in-out disabled:opacity-60 flex items-center justify-center shadow-md hover:shadow-lg btn-glow-indigo focus:outline-none focus:ring-2 focus:ring-indigo-300 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                    </svg>
                    <span id="roleSwapButtonText">역할 변경</span>
                </button>
            </div>
        </div>
    </div>

    <div id="guideModal" class="hidden fixed inset-0 modal-bg-overlay flex items-center justify-center p-4 z-50 fade-in">
        <div id="guideModalContent" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl sm:text-2xl font-bold text-sky-600">SpeakUp AI 사용 가이드 🚀</h2>
                <button id="closeGuideModalButton" class="text-slate-400 hover:text-slate-600 text-3xl transition-colors">&times;</button>
            </div>
            <div class="space-y-3 text-sm sm:text-base text-slate-700">
                <p><strong>1. 🤖 시나리오 선택:</strong><br/> 화면 좌측 상단의 현재 시나리오 버튼 (예: <span class="font-semibold text-sky-600">카페에서</span>)을 클릭하세요. 다양한 카테고리별 대화 상황을 선택하거나, '✨ 사용자 설정'을 통해 직접 원하는 주제를 입력하여 연습할 수 있습니다.</p>
                <p><strong>2. 🎯 집중 주제 (선택 사항):</strong><br/> 시나리오 설명 아래에 있는 입력창에 특별히 연습하고 싶은 어휘나 표현 등을 입력하면 AI가 대화에 더 잘 반영해줍니다. (사용자 설정 시나리오에서는 이 입력창이 없습니다.)</p>
                <p><strong>3. 🗣️ 대화 시작하기:</strong><br/> 화면 상단에 현재 시나리오에 맞는 <span class="text-sky-600 font-medium">"이렇게 시작해 보세요:"</span> 예시 문장들이 제공됩니다. 클릭하면 바로 입력창에 적용돼요! 또는 직접 영어로 메시지를 작성하고 전송 (종이비행기 아이콘) 버튼을 눌러 AI 튜터와 대화를 시작하세요.</p>
                <p><strong>4. ✨ AI 기능 활용하기 (입력창 하단 버튼):</strong></p>
                <ul class="list-disc list-inside pl-4 space-y-1">
                    <li><strong class="text-amber-600">응답 제안:</strong> 대화 중 어떤 말을 해야 할지 막막할 때 누르면, AI가 3가지 응답 예시를 추천해줍니다.</li>
                    <li><strong class="text-teal-600">문장 분석:</strong> 방금 내가 보낸 영어 문장에 대해 AI가 문법, 어휘, 자연스러움 등을 분석하고, <span class="text-sky-600">한국어 요약</span>도 함께 제공합니다.</li>
                    <li><strong class="text-indigo-600">역할 변경:</strong> 현재 시나리오에서 사용자와 AI의 역할을 서로 바꿉니다. (예: 손님 ↔ 점원) 역할이 바뀌면 새로운 시작 표현도 제공됩니다.</li>
                </ul>
                <p><strong>5. 🔄 새 대화 시작:</strong><br/> 화면 우측 상단의 새로고침 아이콘 버튼을 누르면, 현재 선택된 시나리오 (또는 사용자 설정 주제) 및 역할로 대화 내용을 초기화하고 처음부터 다시 연습할 수 있습니다.</p>
            </div>
            <button id="confirmGuideModalButton" class="mt-6 w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-sky-400">
                알겠습니다!
            </button>
        </div>
    </div>

    <div id="analysisModal" class="hidden fixed inset-0 modal-bg-overlay flex items-center justify-center p-4 z-50 fade-in">
        <div id="analysisModalContent" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl sm:text-2xl font-semibold text-sky-700">✨ 내 문장 분석 결과</h3>
                <button id="closeAnalysisModalButtonFromAnalysis" class="text-slate-400 hover:text-slate-600 text-3xl transition-colors">&times;</button>
            </div>
            <div id="englishAnalysisResult" class="mb-5">
                <h4 class="text-lg font-medium text-slate-800 mb-1.5">📝 영어 피드백:</h4>
                <div class="text-base text-slate-700 whitespace-pre-wrap leading-relaxed p-3 bg-slate-50 rounded-md border border-slate-200"></div>
            </div>
            <div id="koreanAnalysisResult">
                <h4 class="text-lg font-medium text-slate-800 mb-1.5">🇰🇷 한국어 요약:</h4>
                <div class="text-base text-slate-700 whitespace-pre-wrap leading-relaxed p-3 bg-sky-50 rounded-md border border-sky-200"></div>
            </div>
            <button id="confirmAnalysisModalButtonFromAnalysis" class="mt-6 w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-sky-400">
                확인했어요!
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => { 
            const scenarioPickerButton = document.getElementById('scenarioPickerButton');
            const currentScenarioDisplay = document.getElementById('currentScenarioDisplay');
            const scenarioDropdown = document.getElementById('scenarioDropdown');
            const headerTitle = document.getElementById('headerTitle'); 
            const newConversationButton = document.getElementById('newConversationButton');
            const helpButton = document.getElementById('helpButton'); 
            
            const scenarioDescriptionArea = document.getElementById('scenarioDescriptionArea');
            const scenarioTitleElem = document.getElementById('scenarioTitle');
            const scenarioDescriptionElem = document.getElementById('scenarioDescription');
            const starterPhrasesContainer = document.getElementById('starterPhrasesContainer');
            const starterPhrasesElem = document.getElementById('starterPhrases');
            const focusTopicGroup = document.getElementById('focusTopicGroup');
            const focusTopicInput = document.getElementById('focusTopicInput');
            const customScenarioGroup = document.getElementById('customScenarioGroup');
            const customScenarioInputElem = document.getElementById('customScenarioInput');

            const messagesContainer = document.getElementById('messagesContainer');
            const userInputElem = document.getElementById('userInput'); 
            const sendMessageButton = document.getElementById('sendMessageButton');

            const suggestedRepliesContainer = document.getElementById('suggestedRepliesContainer');
            const suggestedRepliesList = document.getElementById('suggestedRepliesList');
            const suggestRepliesButton = document.getElementById('suggestRepliesButton');
            const suggestRepliesButtonText = document.getElementById('suggestRepliesButtonText');
            
            const analyzeSentenceButton = document.getElementById('analyzeSentenceButton');
            const analyzeSentenceButtonText = document.getElementById('analyzeSentenceButtonText');
            
            const analysisModal = document.getElementById('analysisModal');
            const analysisModalContent = document.getElementById('analysisModalContent');
            const englishAnalysisResultDiv = document.querySelector('#englishAnalysisResult div');
            const koreanAnalysisResultDiv = document.querySelector('#koreanAnalysisResult div');
            const closeAnalysisModalButtonFromAnalysis = document.getElementById('closeAnalysisModalButtonFromAnalysis'); 
            const confirmAnalysisModalButtonFromAnalysis = document.getElementById('confirmAnalysisModalButtonFromAnalysis'); 
            
            const roleSwapButton = document.getElementById('roleSwapButton');

            const guideModal = document.getElementById('guideModal');
            const guideModalContent = document.getElementById('guideModalContent');
            const closeGuideModalButton = document.getElementById('closeGuideModalButton');
            const confirmGuideModalButton = document.getElementById('confirmGuideModalButton');


            let currentMessages = [];
            let currentScenario; 
            let currentFocusTopic = '';
            let currentCustomScenarioInput = '';
            let isLoading = false;
            let isLoadingSuggestions = false;
            let isLoadingAnalysis = false;
            let showScenarioPicker = false;
            let expandedCategories = {}; 
            let db, auth, currentUserId, isAuthReady = false;
            let userIsPlayingPrimaryRole = true; 

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'ai-tutor-html-default-v1';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                apiKey: "YOUR_API_KEY", 
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

            const scenarioTree = [ 
                { category: "일상 생활 (Everyday Life)", items: [ 
                    { id: "cafe", title: "카페에서 주문하기 ☕", description: "바리스타에게 커피를 주문하고 간단한 요청을 해보세요. AI는 친절한 바리스타 역할을 합니다.", 
                      baseContext: "You are a friendly barista. The user is ordering coffee. Respond concisely (1-2 sentences), ask one question at a time if necessary, and assist with their order. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You are a customer ordering coffee. The user is the barista. Make your order and ask any questions you might have. Keep your requests concise.", 
                      starters_userAsPrimary: ["Hi, can I get a latte?", "Hello! What do you recommend?", "I'd like to order a coffee, please."],
                      starters_userAsOther: ["Hi there! What can I get for you today?", "Welcome! Ready to order?", "Hello! How can I help you?"] }, 
                    { id: "grocery_shopping", title: "식료품점에서 장보기 🛒", description: "점원에게 물건 위치를 묻거나 계산할 때 대화해보세요. AI는 친절한 점원 역할을 합니다.", 
                      baseContext: "You are a helpful grocery store clerk. The user is shopping. Respond concisely (1-2 sentences) and help them find items or checkout. Ask one question at a time if needed. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You are a customer at a grocery store. The user is the clerk. Ask for help or proceed to checkout concisely.",
                      starters_userAsPrimary: ["Excuse me, where can I find the milk?", "How much is this?", "I'd like to pay for these items."],
                      starters_userAsOther: ["Hi! Can I help you find something?", "Are you ready to check out?", "Did you find everything okay?"] },
                    { id: "making_appointments", title: "예약하기 (미용실, 병원 등) 🗓️", description: "전화나 방문을 통해 예약하는 상황을 연습합니다. AI는 접수원 역할을 합니다.", 
                      baseContext: "You are a receptionist at a salon/clinic. The user wants to make an appointment. Guide them concisely (1-2 sentences per turn), asking one question at a time for preferences and confirming details. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You want to make an appointment. The user is the receptionist. State your needs concisely.",
                      starters_userAsPrimary: ["I'd like to make an appointment for a haircut.", "Do you have any openings next Tuesday?", "Can I book a check-up for this week?"],
                      starters_userAsOther: ["Hello, [Salon/Clinic Name], how can I help you?", "Good morning! How may I assist you with scheduling?", "Are you looking to book an appointment?"] },
                    { id: "daily_routine_talk", title: "일상 이야기하기 ☀️", description: "하루 일과나 주말 계획 등 일상적인 주제로 대화합니다. AI는 친구 역할을 합니다.", 
                      baseContext: "You are a friend. The user wants to talk about daily life. Engage in a casual, concise (1-2 sentences per turn) conversation. Ask one question at a time if needed. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You are talking to a friend (the user). Share something about your day or ask about theirs, keeping it concise.",
                      starters_userAsPrimary: ["How was your day?", "What are you up to this weekend?", "I usually [activity] in the morning."],
                      starters_userAsOther: ["Hey! What's new?", "How's it going?", "Anything interesting happen today?"] },
                    { id: "public_transportation", title: "대중교통 이용하기 🚌", description: "버스나 지하철 표를 사거나 길을 묻는 상황입니다. AI는 역무원 또는 다른 승객 역할을 합니다.", 
                      baseContext: "You are a public transport staff or a helpful passenger. The user needs help. Provide clear, concise (1-2 sentences per turn) assistance. Ask one question at a time if needed. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You need help with public transport. The user is staff/passenger. Ask your question concisely.",
                      starters_userAsPrimary: ["Which bus goes to downtown?", "How much is a single ride ticket?", "Is this the platform for the express train?"],
                      starters_userAsOther: ["Can I help you with something?", "Are you looking for a specific line?", "Tickets can be purchased over there."] }
                ]}, 
                { category: "여행 (Travel)", items: [ 
                    { id: "airport_checkin", title: "공항 체크인 ✈️", description: "공항 체크인 카운터에서 탑승 수속을 진행합니다.", baseContext: "You are an airline check-in agent. The user is checking in for a flight. Ask for passport/ticket, discuss baggage, seat preferences. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are at the airport checking in for your flight. The user is the check-in agent. Provide your documents and discuss your flight details concisely.", starters_userAsPrimary: ["I'd like to check in for my flight to London.", "Here's my passport and ticket.", "Can I have a window seat, please?"], starters_userAsOther: ["Good [morning/afternoon/evening]! May I see your passport and ticket, please?", "Where are you flying to today?", "Do you have any bags to check in?"] }, 
                    { id: "hotel_checkin", title: "호텔 체크인 🏨", description: "호텔 프론트에서 예약 확인 및 체크인을 합니다.", baseContext: "You are a hotel receptionist. The user is checking in. Confirm reservation, explain amenities, answer questions. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are checking into a hotel. The user is the receptionist. Provide your reservation details and ask any necessary questions concisely.", starters_userAsPrimary: ["I have a reservation under the name [Your Name].", "Could you tell me what time breakfast is served?", "Is there Wi-Fi in the room?"], starters_userAsOther: ["Welcome to our hotel! How can I help you?", "Do you have a reservation with us?", "May I have your name, please?"] }, 
                    { id: "asking_directions", title: "길 묻기 🗺️", description: "여행 중 모르는 곳에서 길을 묻는 상황입니다.", baseContext: "You are a local resident. The user is a tourist asking for directions. Provide clear, concise (1-2 sentences) instructions and be helpful. Ask one question at a time if needed.", baseContext_swapped:"You are a tourist asking for directions. The user is a local resident. Ask for help finding your way concisely.", starters_userAsPrimary: ["Excuse me, how can I get to the museum?", "Could you show me on the map?", "Is this the right way to the train station?"], starters_userAsOther: ["Yes, how can I help you?", "Where are you trying to go?", "Sure, I can help with that."] }, 
                    { id: "ordering_at_restaurant_travel", title: "여행 중 식당 주문 🍽️", description: "여행지 식당에서 음식을 주문하고 현지 음식에 대해 질문합니다.", baseContext: "You are a waiter/waitress in a tourist-friendly restaurant. The user is ordering food and might ask about local specialties. Be patient and helpful. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are a customer at a restaurant in a tourist area. The user is the waiter/waitress. Order food and ask about the menu concisely.", starters_userAsPrimary: ["What's the local specialty here?", "I'd like to try something traditional.", "Can you recommend a dish?"], starters_userAsOther: ["Welcome! Are you ready to order, or do you need a few more minutes?", "Can I get you started with something to drink?", "What can I get for you?"] },
                    { id: "booking_tour", title: "여행 상품 예약하기 🏞️", description: "현지 투어나 액티비티를 예약하는 상황입니다.", baseContext: "You are a travel agent or tour operator. The user wants to book a tour or activity. Provide information about options, prices, and make the booking. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You want to book a local tour or activity. The user is the travel agent. Inquire about options and make a booking concisely.", starters_userAsPrimary: ["I'm interested in booking a city tour.", "What kind of tours do you offer?", "How much does the [tour name] cost?"], starters_userAsOther: ["Hello! How can I help you plan your activities today?", "We have several tours available. What are you interested in?", "Certainly, let me check the availability for you."] },
                    { id: "at_immigration", title: "입국 심사대에서 🛂", description: "공항 입국 심사대에서 심사관의 질문에 답변합니다.", baseContext: "You are an immigration officer. The user is arriving in the country. Ask about the purpose of their visit, length of stay, and check their documents. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are at immigration control upon arriving in a new country. The user is the immigration officer. Answer their questions about your visit concisely.", starters_userAsPrimary: ["Good morning. May I see your passport?", "What is the purpose of your visit?", "How long do you plan to stay?"], starters_userAsOther: ["Next, please. Passport and landing card.", "Good [morning/afternoon]. Welcome to [Country].", "What is the purpose of your visit to [Country]?"] }
                ]}, 
                { category: "직장 생활 (Work & Business)", items: [ 
                    { id: "job_interview", title: "면접 보기 💼", description: "구직 면접 상황을 연습합니다. 자기소개, 질문 답변 등", baseContext: "You are an interviewer for a job position. The user is a candidate. Ask common interview questions and evaluate their responses in English. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are a candidate at a job interview. The user is the interviewer. Answer questions about your qualifications and experience concisely.", starters_userAsPrimary: ["Tell me about yourself.", "Why are you interested in this position?", "What are your strengths?"], starters_userAsOther: ["Thank you for coming in today. Please, have a seat.", "So, tell me a little bit about yourself.", "Why are you interested in this role at our company?"] }, 
                    { id: "meeting_colleagues", title: "동료와 회의하기 👥", description: "업무 관련 회의에서 의견을 제시하고 토론합니다.", baseContext: "You are a colleague in a business meeting. The user is participating in the meeting. Discuss agenda items, share opinions, and collaborate. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are participating in a business meeting with colleagues. The user is one of your colleagues. Share your opinions and discuss agenda items concisely.", starters_userAsPrimary: ["I'd like to suggest an idea.", "What are your thoughts on this proposal?", "Let's discuss the next steps."], starters_userAsOther: ["Okay team, let's get started. The first item on the agenda is...", "Does anyone have any initial thoughts on this?", "Thanks for sharing, [User's Name]. What does everyone else think?"] }, 
                    { id: "phone_call_business", title: "업무 전화 통화 📞", description: "비즈니스 목적으로 전화를 걸거나 받는 상황입니다.", baseContext: "You are a business professional on a phone call. The user is either initiating or receiving a business call. Handle inquiries, schedule meetings, or discuss projects professionally. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are making or receiving a business phone call. The user is the other party. Discuss professional matters, schedule appointments, or make inquiries concisely.", starters_userAsPrimary: ["Hello, this is [Your Name] from [Your Company].", "May I speak to Mr./Ms. [Name]?", "I'm calling to inquire about..."], starters_userAsOther: ["Good morning, [Company Name], [Your Name] speaking. How can I help you?", "Hello, thank you for calling. This is [Your Name].", "[User's Name] speaking."] },
                    { id: "presentation_qna", title: "발표 후 질의응답 🎤", description: "발표를 마친 후 청중의 질문에 답변하는 상황입니다.", baseContext: "You are an audience member after a presentation. The user is the presenter. Ask relevant questions about their presentation. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are the presenter who has just finished a presentation. The user is an audience member asking questions. Answer their questions clearly and concisely.", starters_userAsPrimary: ["Thank you for your presentation. I have a question about...", "Could you elaborate on [specific point]?", "What are the implications of your findings?"], starters_userAsOther: ["Thank you for that insightful presentation. We now have some time for questions.", "Any questions for our speaker?", "Yes, the person in the back?"] },
                    { id: "networking_event", title: "네트워킹 행사 🤝", description: "업계 행사에서 새로운 사람들과 교류하며 대화합니다.", baseContext: "You are attending a networking event. The user is also an attendee. Initiate or respond to conversations to build professional connections. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are attending a networking event. The user is another attendee. Engage in conversation to build professional connections concisely.", starters_userAsPrimary: ["Hi, I'm [Your Name]. What brings you to this event?", "That's an interesting point. Could you tell me more?", "It was nice talking to you. Here's my card."], starters_userAsOther: ["Hello! Enjoying the event?", "Hi, I don't think we've met. I'm [Your Name].", "What line of work are you in?"] }
                ]}, 
                { category: "취미 및 관심사 (Hobbies & Interests)", items: [ 
                    { id: "discussing_movie", title: "영화 이야기하기 🎬", description: "최근에 본 영화나 좋아하는 영화에 대해 친구와 이야기합니다.", baseContext: "You are a friend discussing movies with the user. Talk about recent movies, favorite genres, actors, etc. Encourage the user to express their opinions in English. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are discussing movies with a friend (the user). Share your opinions about movies, genres, actors, etc. concisely.", starters_userAsPrimary: ["Have you seen any good movies lately?", "What's your favorite type of movie?", "I recently watched [Movie Title]..."], starters_userAsOther: ["So, any new movies you'd recommend?", "I'm looking for a good movie to watch, any ideas?", "What did you think of [Movie Title]?"] }, 
                    { id: "talking_about_music", title: "음악 취향 공유하기 🎶", description: "좋아하는 음악 장르, 가수, 노래에 대해 이야기 나눕니다.", baseContext: "You are a friend talking about music. Discuss favorite genres, artists, songs, concerts, etc. Help the user share their musical tastes in English. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are talking about music with a friend (the user). Share your musical tastes, favorite artists, songs, etc. concisely.", starters_userAsPrimary: ["What kind of music do you like?", "Who's your favorite singer?", "Have you heard the new song by [Artist]?"], starters_userAsOther: ["I'm always looking for new music. Any recommendations?", "What have you been listening to lately?", "Do you like [Genre/Artist]?"] }, 
                    { id: "discussing_books", title: "책에 대해 대화하기 📚", description: "읽은 책이나 좋아하는 작가, 장르에 대해 이야기합니다.", baseContext: "You are a fellow book lover. The user wants to discuss books they've read, favorite authors, or genres. Share your thoughts and ask them about theirs. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are discussing books with a fellow book lover (the user). Talk about books you've read, favorite authors, or genres concisely.", starters_userAsPrimary: ["What are you reading currently?", "Do you have a favorite author?", "I just finished a great book called..."], starters_userAsOther: ["Read any good books lately?", "I'm looking for a new book. Any suggestions?", "What kind of books do you usually enjoy?"] }, 
                    { id: "talking_about_sports", title: "스포츠 이야기하기 ⚽", description: "좋아하는 스포츠, 팀, 선수에 대해 이야기합니다.", baseContext: "You are a sports enthusiast. The user wants to talk about sports. Discuss favorite sports, teams, players, recent games, etc. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are talking about sports with an enthusiast (the user). Discuss your favorite sports, teams, players, or recent games concisely.", starters_userAsPrimary: ["Did you watch the game last night?", "Who's your favorite team?", "I love playing [sport]."], starters_userAsOther: ["That was some game last night, wasn't it?", "Are you a fan of [Sport/Team]?", "What sports do you follow?"] } 
                ]}, 
                { category: "사교 활동 (Socializing)", items: [ 
                    { id: "meeting_new_people", title: "새로운 사람과 스몰톡 👋", description: "파티나 모임에서 처음 만난 사람과 가벼운 대화를 나눕니다.", baseContext: "You are someone the user has just met at a social event. Engage in small talk, ask about their interests, job, etc., to help them practice initiating conversations with new people. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You have just met someone (the user) at a social event. Engage in small talk, share your interests, or ask about theirs concisely.", starters_userAsPrimary: ["Hi, I'm [Your Name]. Nice to meet you.", "So, what do you do for a living?", "Are you enjoying the event?"], starters_userAsOther: ["Hello! I don't think we've met. I'm [Your Name].", "Great event, isn't it?", "Hi there, mind if I join you?"] }, 
                    { id: "inviting_friend", title: "친구 초대하기 (식사, 영화 등) 📧", description: "친구에게 식사나 영화 관람 등을 제안하고 약속을 잡습니다.", baseContext: "You are a friend of the user. The user wants to invite you out for a meal, movie, or another activity. Respond to their invitation, discuss plans, and confirm details. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You want to invite your friend (the user) for an activity. Make an invitation, suggest plans, and confirm details concisely.", starters_userAsPrimary: ["Are you free to grab dinner on Friday?", "I was wondering if you'd like to see a movie with me.", "Let's hang out sometime next week."], starters_userAsOther: ["Hey, what are you up to later?", "I was thinking of [activity], want to join?", "We should get together soon."] }, 
                    { id: "accepting_declining_invitation", title: "초대 수락/거절하기 ✅❌", description: "친구의 초대에 대해 수락하거나 정중히 거절하는 방법을 연습합니다.", baseContext: "You have invited the user to an event. The user will practice accepting or declining your invitation politely. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You have been invited to an event by the user. Practice accepting or declining the invitation politely and concisely.", starters_userAsPrimary: ["Thanks for inviting me! I'd love to come.", "That sounds great, but I'm afraid I have other plans.", "I appreciate the invitation, but I don't think I can make it."], starters_userAsOther: ["I'm having a get-together on Saturday, would you like to come?", "Want to catch a movie this weekend?", "I'm planning a [event], hope you can make it!"] } 
                ]}, 
                { category: "문제 해결 및 요청 (Problem Solving & Requests)", items: [ 
                    { id: "returning_item", title: "물건 환불/교환하기 🛍️", description: "상점에서 구매한 물건을 환불하거나 교환 요청하는 상황입니다.", baseContext: "You are a store clerk. The user wants to return or exchange an item they purchased. Ask for the reason, receipt, and guide them through the store's policy. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You want to return or exchange an item at a store. The user is the store clerk. Explain your reason and follow the process concisely.", starters_userAsPrimary: ["I'd like to return this item, please.", "Can I exchange this for a different size?", "There's a problem with this product I bought."], starters_userAsOther: ["Hi, how can I help you today?", "Do you have your receipt?", "What seems to be the problem with the item?"] }, 
                    { id: "tech_support", title: "기술 지원 문의하기 💻", description: "제품 사용 중 문제가 발생하여 기술 지원팀에 문의합니다.", baseContext: "You are a technical support agent. The user is calling about an issue with a product or service. Help them troubleshoot the problem or escalate the issue. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are calling technical support for an issue with a product or service. The user is the support agent. Describe your problem and seek assistance concisely.", starters_userAsPrimary: ["I'm having trouble with my [product/service].", "My internet isn't working.", "Could you help me fix this error?"], starters_userAsOther: ["Thank you for calling Tech Support, my name is [Your Name]. How can I help you?", "Could you please describe the issue you're experiencing?", "Have you tried restarting your device?"] }, 
                    { id: "making_complaint", title: "불만 제기하기 (호텔, 식당 등) 😠", description: "서비스나 제품에 대한 불만을 정중하게 표현합니다.", baseContext: "You are a manager or customer service representative. The user has a complaint about a service or product. Listen to their concerns and try to resolve the issue. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You have a complaint about a service or product. The user is the manager or customer service representative. Express your dissatisfaction politely and concisely.", starters_userAsPrimary: ["I'm afraid I have a complaint about...", "I'm not satisfied with the service I received.", "Could I speak to the manager, please?"], starters_userAsOther: ["I understand you have a concern. Please tell me what happened.", "I'm sorry to hear you're not satisfied. How can I make things right?", "Thank you for bringing this to my attention."] } 
                ]}, 
                { category: "건강 및 의료 (Health & Medical)", items: [ 
                    { id: "hospital_visit", title: "병원 방문 (일반 진료) 🏥", description: "의사나 간호사에게 증상을 설명하고 진료 관련 대화를 나눕니다. AI는 의료진 역할을 합니다.", 
                      baseContext: "You are a doctor or nurse at a hospital. The user is a patient explaining their symptoms. Ask clarifying questions ONE AT A TIME. Keep responses concise (1-2 sentences) and professional. Do not ask many questions at once. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You are a patient visiting a doctor/nurse (the user). Describe your symptoms or ask for advice concisely. Respond to one question at a time.", 
                      starters_userAsPrimary: ["I'd like to see a doctor. I'm not feeling well.", "I have a persistent cough and a sore throat.", "I think I might have sprained my ankle."],
                      starters_userAsOther: ["Hello, what seems to be the problem today?", "Good morning. How can I help you?", "Please tell me what's bothering you."] }, 
                    { id: "dentist_visit", title: "치과 방문 🦷", description: "치과 의사나 위생사에게 치아 문제를 설명하거나 정기 검진 관련 대화를 합니다. AI는 치과 의료진 역할을 합니다.", 
                      baseContext: "You are a dentist or dental hygienist. The user is a patient. Ask about their dental issue or needs. Keep questions focused and concise (1-2 sentences per turn). Ask ONE question at a time. Do not ask questions you've already received answers for.", 
                      baseContext_swapped: "You are a patient at a dental clinic. The user is the dentist/hygienist. Explain your dental concern or reason for visit concisely. Respond to one question at a time.", 
                      starters_userAsPrimary: ["I have a toothache, and I'd like to make an appointment.", "I'm here for my 6-month check-up and cleaning.", "This tooth has been really sensitive to cold lately."],
                      starters_userAsOther: ["Hi, welcome to our dental clinic. How can I help you today?", "What brings you in to see us?", "Are you here for a check-up or a specific issue?"] } 
                ]},
                { category: "특별한 상황 (Special Occasions)", items: [ { id: "birthday_party", title: "생일 파티 대화 🎉", description: "생일 축하 메시지를 전하고 파티에서 대화합니다.", baseContext: "You are a guest at a birthday party. The user is also a guest or the birthday person. Engage in light conversation, offer good wishes. Respond concisely (1-2 sentences) and one question at a time. Do not ask questions you've already received answers for.", baseContext_swapped:"You are at a birthday party. The user is another guest or the birthday person. Engage in conversation and offer good wishes concisely.", starters_userAsPrimary: ["Happy birthday!", "This is a great party!", "How are you enjoying your special day?"], starters_userAsOther: ["Thanks for coming to my party!", "So glad you could make it!", "Are you having a good time?"] }, { id: "congratulating_someone", title: "축하 표현하기 🥳", description: "다른 사람의 좋은 일(승진, 졸업 등)을 축하합니다.", baseContext: "You are a friend or colleague of the user. The user wants to congratulate you or someone else on an achievement. Respond appropriately and concisely (1-2 sentences). Do not ask questions you've already received answers for.", baseContext_swapped:"You want to congratulate a friend or colleague (the user) on an achievement. Express your congratulations concisely.", starters_userAsPrimary: ["Congratulations on your promotion!", "That's fantastic news! Well done.", "I'm so happy for you!"], starters_userAsOther: ["Thank you so much!", "I really appreciate that.", "It means a lot to hear that from you."] } ] }, 
                { category: "사용자 설정", isCustomCategory: true, items: [ { id: "custom", title: "직접 입력 ✨", description: "연습하고 싶은 상황이나 주제를 아래에 자세히 입력해주세요.", baseContext: "", baseContext_swapped: "", starters_userAsPrimary: ["Let's talk about [your topic].", "I want to practice discussing [your situation].", "Can we simulate a conversation about [your scenario]?"], starters_userAsOther: ["Okay, I'm ready for the custom scenario you described. What's my first line?", "I understand the custom scenario. How should I begin as the other person?", "Let's start the custom role-play. What's my role according to your description?"] } ] } 
            ];
            const findScenarioById = (id) => { for (const category of scenarioTree) { const found = category.items.find(item => item.id === id); if (found) return { ...found, categoryTitle: category.category }; } return null; };
            
            function initializeAppLogic() { const firebaseApp = initializeApp(firebaseConfig); auth = getAuth(firebaseApp); db = getFirestore(firebaseApp); onAuthStateChanged(auth, async (user) => { let finalUserId = null; if (user) { finalUserId = user.uid; } else { try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { const userCredential = await signInWithCustomToken(auth, __initial_auth_token); finalUserId = userCredential.user.uid; } else { const userCredential = await signInAnonymously(auth); finalUserId = userCredential.user.uid; } } catch (error) { console.error("로그인 실패:", error); } } if (finalUserId) { currentUserId = finalUserId; const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'info'); try { const docSnap = await getDoc(userProfileRef); let loadedScenarioData = findScenarioById("cafe"); let loadedFocusTopic = ''; let loadedCustomInput = ''; let loadedRoleIsUserPrimary = true; if (docSnap.exists()) { const profileData = docSnap.data(); const lastScenarioId = profileData.lastScenarioId; const foundScenarioFromDB = findScenarioById(lastScenarioId); if (foundScenarioFromDB) { loadedScenarioData = foundScenarioFromDB; if (foundScenarioFromDB.id === "custom" && profileData.lastCustomScenarioDetails) { loadedCustomInput = profileData.lastCustomScenarioDetails.description || ""; loadedScenarioData = { ...loadedScenarioData, title: profileData.lastCustomScenarioDetails.title || "사용자 설정 연습" }; } else if (foundScenarioFromDB.id !== "custom") { loadedFocusTopic = profileData.lastFocusTopic || ''; } loadedRoleIsUserPrimary = profileData.lastRoleIsUserPrimary !== undefined ? profileData.lastRoleIsUserPrimary : true; } } currentScenario = loadedScenarioData || findScenarioById("cafe"); // 방어 코드
                currentFocusTopic = loadedFocusTopic; currentCustomScenarioInput = loadedCustomInput; userIsPlayingPrimaryRole = loadedRoleIsUserPrimary; updateScenarioDisplay(); focusTopicInput.value = currentFocusTopic; customScenarioInputElem.value = currentCustomScenarioInput; await setDoc(userProfileRef, { lastLogin: serverTimestamp(), lastScenarioId: currentScenario.id, lastRoleIsUserPrimary: userIsPlayingPrimaryRole, ...(currentScenario.id === "custom" && currentCustomScenarioInput ? { lastCustomScenarioDetails: { title: currentScenario.title, description: currentCustomScenarioInput } } : {}), ...(currentScenario.id !== "custom" ? { lastFocusTopic: currentFocusTopic } : {}) }, { merge: true }); } catch (error) { console.error("사용자 프로필 처리 오류:", error); currentScenario = findScenarioById("cafe"); updateScenarioDisplay(); } } isAuthReady = true; }); }
            
            function getDynamicContext() { if (!currentScenario) return "You are a general English language tutor. No scenario selected."; let scenarioSpecificContext = ""; if (currentScenario.id === "custom") { if (!currentCustomScenarioInput.trim()) return "You are a general English language tutor. The user hasn't specified a topic yet. Ask what they'd like to talk about. Keep responses concise and ask one question at a time."; if (!userIsPlayingPrimaryRole) { scenarioSpecificContext = `ROLE SWAP: You are now the conversation partner based on the user's custom scenario: "${currentCustomScenarioInput}". The human user will act as your AI tutor or guide. Please respond naturally based on the scenario, keeping your responses concise (1-2 sentences) and asking only one question at a time if needed. Do not ask questions you've already received answers for.`; } else { scenarioSpecificContext = `You are a friendly and helpful English language tutor. The user wants to practice a conversation based on their custom scenario: "${currentCustomScenarioInput}". Act as a partner for this topic, ask relevant questions, and help with their English. Keep responses concise (1-2 sentences) and ask only one question at a time if needed. Do not ask questions you've already received answers for.`; } } else { if (userIsPlayingPrimaryRole) { scenarioSpecificContext = currentScenario.baseContext; } else { scenarioSpecificContext = currentScenario.baseContext_swapped || `ROLE SWAP! You are now taking on the role typically played by the AI in the "${currentScenario.title}" scenario. For example, if the user was the customer at a cafe, you are now the customer. The human user is playing the other part (e.g., barista). Please initiate or respond accordingly, keeping your responses concise (1-2 sentences) and asking only one question at a time if needed. Do not ask questions you've already received answers for.`; } } const focusTopicInstruction = (userIsPlayingPrimaryRole && currentFocusTopic && currentScenario.id !== "custom") ? `\n\nThe user also wants to focus on: "${currentFocusTopic}". Try to incorporate this into the conversation.` : ''; return `${scenarioSpecificContext}${focusTopicInstruction}`; }
            async function callGeminiAPI(prompt) { const payload = { message: prompt }; const API_ENDPOINT = "https://magenta-morning-find.glitch.me/generate"; const apiUrl = API_ENDPOINT; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { let errorDetails = `서버 응답: ${response.statusText || '알 수 없는 오류'}`; try { const errorData = await response.json(); errorDetails = errorData.error || errorData.message || (typeof errorData === 'object' ? JSON.stringify(errorData) : String(errorData)); if (!errorDetails || errorDetails === '{}' || errorDetails.trim() === "") { errorDetails = `서버 응답: ${response.statusText || '오류 내용 없음'}`; } } catch (jsonError) { console.warn("API 오류 응답이 JSON이 아니므로 텍스트로 읽기를 시도합니다.", jsonError); try { const errorText = await response.text(); errorDetails = errorText.trim() || `서버 응답: ${response.statusText || '오류 내용 없음'}`; } catch (textError) { console.error("API 오류 응답을 텍스트로 읽는 데 실패했습니다.", textError); errorDetails = `서버 응답: ${response.statusText || '알 수 없는 오류'}, 응답 본문 읽기 실패`; } } const errorMsg = `API 요청 실패 (${response.status}): ${errorDetails}`; console.error("API Error Details:", errorDetails); throw new Error(errorMsg); } const result = await response.json(); if (result.text) { return result.text; } else if (result.generated_text) { return result.generated_text; } else if (result.reply) { return result.reply; } else if (typeof result === 'string') { return result; } else if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) { console.warn("Gemini API 형식의 응답을 받았습니다. Glitch 엔드포인트가 이 형식을 지원하는지 확인하세요."); return result.candidates[0].content.parts[0].text; } else { console.error("API 응답에서 텍스트를 추출할 수 없거나, 예상치 못한 구조입니다:", result); throw new Error('AI로부터 유효한 텍스트 응답을 받지 못했습니다.'); } } catch (error) { console.error("API 호출 중 예외 발생:", error); throw error; } }

            function updateScenarioDisplay(isConversationStarting = false) { if (!currentScenario) return; const displayTitle = currentScenario.id === 'custom' ? (currentCustomScenarioInput ? `사용자 설정: ${currentCustomScenarioInput.substring(0,10)}...` : "사용자 설정") : (currentScenario.categoryTitle ? `${currentScenario.title.split(" ")[0]}` : currentScenario.title.split(" ")[0]); currentScenarioDisplay.textContent = displayTitle; headerTitle.title = currentScenario.title; scenarioTitleElem.textContent = currentScenario.id === "custom" ? (currentCustomScenarioInput ? `주제: ${currentCustomScenarioInput.substring(0,40)}...` : "사용자 설정 시나리오") : currentScenario.title; const elementsToHide = document.querySelectorAll('.hide-after-conversation-start'); if (isConversationStarting) { elementsToHide.forEach(el => el.classList.add('hidden')); scenarioDescriptionArea.classList.remove('pb-4', 'sm:pb-5'); scenarioTitleElem.classList.remove('mb-1.5'); scenarioTitleElem.classList.add('mb-0'); } else { elementsToHide.forEach(el => el.classList.remove('hidden')); scenarioDescriptionElem.textContent = currentScenario.id === "custom" ? scenarioTree.find(c=>c.isCustomCategory).items[0].description : currentScenario.description; starterPhrasesElem.innerHTML = ''; const starters = userIsPlayingPrimaryRole ? (currentScenario.starters_userAsPrimary || currentScenario.starters) : currentScenario.starters_userAsOther; if (starters && starters.length > 0) { starterPhrasesContainer.classList.remove('hidden'); starters.forEach(starter => { const button = document.createElement('button'); button.className = "text-xs bg-sky-100 hover:bg-sky-200 text-sky-700 px-2 py-1 rounded-md shadow-sm transition-colors"; button.textContent = `"${starter}"`; button.onclick = () => { userInputElem.value = starter; }; starterPhrasesElem.appendChild(button); }); } else { starterPhrasesContainer.classList.add('hidden'); } if (currentScenario.id === "custom") { customScenarioGroup.classList.remove('hidden'); focusTopicGroup.classList.add('hidden'); } else { customScenarioGroup.classList.add('hidden'); focusTopicGroup.classList.remove('hidden'); } scenarioDescriptionArea.classList.remove('hidden'); scenarioDescriptionArea.classList.add('pb-4', 'sm:pb-5'); scenarioTitleElem.classList.add('mb-1.5'); scenarioTitleElem.classList.remove('mb-0'); } }
            
            function renderScenarioPicker() { scenarioDropdown.innerHTML = ''; scenarioTree.forEach(category => { const categoryDiv = document.createElement('div'); const categoryHeader = document.createElement('div'); categoryHeader.className = `flex justify-between items-center p-1.5 sm:p-2 hover:bg-sky-100 cursor-pointer text-slate-800 font-medium text-xs sm:text-sm category-header`; if (category.isCustomCategory && currentScenario && currentScenario.id === category.items[0].id) { categoryHeader.classList.add('scenario-picker-item-selected'); } const categoryTitleSpan = document.createElement('span'); categoryTitleSpan.textContent = category.category; categoryHeader.appendChild(categoryTitleSpan); if (!category.isCustomCategory) { const chevron = document.createElement('span'); const svgNS = "http://www.w3.org/2000/svg"; const svgEl = document.createElementNS(svgNS, "svg"); svgEl.setAttribute("viewBox", "0 0 20 20"); svgEl.setAttribute("fill", "currentColor"); svgEl.classList.add("w-5", "h-5", "transform", "transition-transform"); if (expandedCategories[category.category]) { svgEl.classList.add("rotate-90"); } else { svgEl.classList.remove("rotate-90"); } const pathEl = document.createElementNS(svgNS, "path"); pathEl.setAttribute("fill-rule", "evenodd"); pathEl.setAttribute("d", "M7.21 14.77a.75.75 0 0 1 .02-1.06L11.168 10 7.23 6.29a.75.75 0 1 1 1.04-1.08l4.5 4.25a.75.75 0 0 1 0 1.08l-4.5 4.25a.75.75 0 0 1-1.06-.02Z"); pathEl.setAttribute("clip-rule", "evenodd"); svgEl.appendChild(pathEl); chevron.appendChild(svgEl); categoryHeader.appendChild(chevron); } categoryHeader.onclick = (event) => { event.stopPropagation(); if (category.isCustomCategory) { handleScenarioSelect(category.items[0]); } else { expandedCategories[category.category] = !expandedCategories[category.category]; renderScenarioPicker(); } }; categoryDiv.appendChild(categoryHeader); if (expandedCategories[category.category] && !category.isCustomCategory) { const itemsDiv = document.createElement('div'); itemsDiv.className = "pl-3 border-l border-sky-200"; category.items.forEach(item => { const itemDiv = document.createElement('div'); itemDiv.className = `py-1 px-1.5 sm:py-1.5 sm:px-2 text-xs hover:bg-sky-50 cursor-pointer text-slate-600 scenario-picker-item`; if (currentScenario && currentScenario.id === item.id) { itemDiv.classList.add('scenario-picker-item-selected'); } itemDiv.textContent = item.title; itemDiv.onclick = (event) => { event.stopPropagation(); handleScenarioSelect(item); }; itemsDiv.appendChild(itemDiv); }); categoryDiv.appendChild(itemsDiv); } scenarioDropdown.appendChild(categoryDiv); }); }
            function toggleScenarioPicker() { showScenarioPicker = !showScenarioPicker; if (showScenarioPicker) { renderScenarioPicker(); scenarioDropdown.classList.remove('hidden'); scenarioDropdown.classList.add('fade-in'); } else { scenarioDropdown.classList.add('hidden'); expandedCategories = {}; } }
            function handleScenarioSelect(scenarioItem) { if (isLoading) { alert("AI가 응답 중일 때는 시나리오를 변경할 수 없습니다."); return; } const fullScenarioDetails = findScenarioById(scenarioItem.id); currentScenario = fullScenarioDetails; currentMessages = []; userInputElem.value = ''; suggestedRepliesList.innerHTML = ''; suggestedRepliesContainer.classList.add('hidden'); closeAnalysisModal(); userIsPlayingPrimaryRole = true; if (scenarioItem.id !== "custom") { currentCustomScenarioInput = ''; customScenarioInputElem.value = ''; } else { currentFocusTopic = ''; focusTopicInput.value = ''; } updateScenarioDisplay(false); renderMessages(); toggleScenarioPicker(); }
            function handleNewConversation() { if (isLoading) { alert("AI가 응답 중일 때는 새 대화를 시작할 수 없습니다."); return; } currentMessages = []; userInputElem.value = ''; suggestedRepliesList.innerHTML = ''; suggestedRepliesContainer.classList.add('hidden'); closeAnalysisModal(); userIsPlayingPrimaryRole = true; updateScenarioDisplay(false); renderMessages(); const scenarioTitleForAlert = currentScenario.id === 'custom' ? (currentCustomScenarioInput || '사용자 설정') : currentScenario.title; alert(`"${scenarioTitleForAlert}" 시나리오로 새 대화를 시작합니다.`); }
            
            function simpleMarkdownToHtml(text) { if (!text) return ''; let html = text; html = html.replace(/\*\*(.*?)\*\*|__(.*?)__/g, '<strong>$1$2</strong>'); html = html.replace(/\*(.*?)\*|_(.*?)_/g, '<em>$1$2</em>'); html = html.replace(/~~(.*?)~~/g, '<del>$1</del>'); html = html.replace(/^\s*[\*\-\+]\s+(.*)/gm, '<li>$1</li>'); html = html.replace(/<\/li>\s*<li>/g, '</li><li>'); if (html.includes('<li>')) { const listItems = html.match(/<li>.*?<\/li>/g); if (listItems) { html = `<ul>${listItems.join('')}</ul>`; } } html = html.replace(/\n/g, '<br />'); html = html.replace(/<li><br \/>/g, '<li>'); html = html.replace(/<br \/><\/li>/g, '</li>'); html = html.replace(/<br \/>\s*<ul>/g, '<ul>'); html = html.replace(/<\/ul>\s*<br \/>/g, '</ul>'); return html; }

            function renderMessages() { messagesContainer.innerHTML = ''; currentMessages.forEach(msg => { const messageWrapper = document.createElement('div'); messageWrapper.className = `flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`; const messageBubble = document.createElement('div'); messageBubble.className = `max-w-3/4 sm:max-w-md lg:max-w-lg px-3 py-2 sm:px-4 sm:py-2.5 rounded-2xl shadow ${ msg.sender === 'user' ? 'user-bubble text-white rounded-br-none' : 'ai-bubble text-slate-800 rounded-bl-none' }`; messageBubble.innerHTML = simpleMarkdownToHtml(msg.text); messageWrapper.appendChild(messageBubble); messagesContainer.appendChild(messageWrapper); }); messagesContainer.scrollTop = messagesContainer.scrollHeight; }
            function setLoadingState(buttonId, textWhileLoading, isLoadingFlag) { const button = document.getElementById(buttonId); const buttonTextSpan = document.getElementById(`${buttonId}Text`); if (button && buttonTextSpan) { button.disabled = isLoadingFlag; buttonTextSpan.textContent = isLoadingFlag ? textWhileLoading : (buttonId === 'suggestRepliesButton' ? 'AI 응답 제안' : '내 문장 분석'); } }
            
            async function handleSendMessage() { 
                if (userInputElem.value.trim() === '' || isLoading) return; 
                if (currentScenario.id === "custom" && currentCustomScenarioInput.trim() === '' && currentMessages.length === 0) { 
                    alert("사용자 정의 시나리오 내용을 먼저 입력해주세요."); 
                    return; 
                } 
                const newUserMessage = { sender: 'user', text: userInputElem.value.trim(), timestamp: new Date() }; 
                currentMessages.push(newUserMessage); 
                renderMessages(); 
                const currentInputForAPI = userInputElem.value; 
                userInputElem.value = ''; 
                isLoading = true; 
                sendMessageButton.disabled = true; 
                sendMessageButton.innerHTML = `<svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"> <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path> </svg>`; 
                
                updateScenarioDisplay(true); 
                
                suggestedRepliesList.innerHTML = ''; 
                suggestedRepliesContainer.classList.add('hidden'); 
                closeAnalysisModal(); 
                if (db && currentUserId) { try { await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/conversations/${currentScenario.id === "custom" ? `custom_${currentCustomScenarioInput.substring(0,10).replace(/\s/g, '_')}` : currentScenario.id}/messages`), { ...newUserMessage, timestamp: serverTimestamp() }); } catch (error) { console.error("사용자 메시지 저장 오류:", error); } } 
                
                const contextForAI = getDynamicContext();
                // 이전 대화 내용을 포함하여 프롬프트 구성
                let conversationHistoryForAPI = "Previous conversation:\n";
                currentMessages.slice(Math.max(0, currentMessages.length - 7), -1).forEach(msg => { // 최근 6개 메시지 (3턴)
                    conversationHistoryForAPI += `${msg.sender === 'user' ? 'User' : 'AI'}: ${msg.text}\n`;
                });

                const promptForAI = `System Instruction: ${contextForAI}\n\n${currentMessages.length > 1 ? conversationHistoryForAPI : ''}User: ${currentInputForAPI}`;


                try { 
                    const aiResponseText = await callGeminiAPI(promptForAI); 
                    const newAiMessage = { sender: 'ai', text: aiResponseText, timestamp: new Date() }; 
                    currentMessages.push(newAiMessage); 
                    renderMessages(); 
                    if (db && currentUserId) { try { await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/conversations/${currentScenario.id === "custom" ? `custom_${currentCustomScenarioInput.substring(0,10).replace(/\s/g, '_')}` : currentScenario.id}/messages`), { ...newAiMessage, timestamp: serverTimestamp() }); } catch (error) { console.error("AI 메시지 저장 오류:", error); } } 
                } catch (error) { 
                    currentMessages.push({ sender: 'ai', text: `AI 응답 오류: ${error.message}`, timestamp: new Date() }); 
                    renderMessages(); 
                } finally { 
                    isLoading = false; 
                    sendMessageButton.disabled = false; 
                    sendMessageButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"> <path d="M3.5 2.75a.75.75 0 00-1.061.645l1.906 11.438a.75.75 0 001.412-.001L7.25 9.086l5.438-4.078a.75.75 0 00-.816-1.299L4.06 7.354 3.5 2.75zM2.75 16.5a.75.75 0 001.061.645l12.626-7.575a.75.75 0 000-1.29l-12.626-7.575A.75.75 0 002.75 1.5v15z" /> </svg>`; 
                } 
            }
            async function handleSuggestRepliesLogic() { if (isLoadingSuggestions || currentMessages.length === 0) return; isLoadingSuggestions = true; setLoadingState('suggestRepliesButton', '로딩중...', true); closeAnalysisModal(); try { const lastMessage = currentMessages[currentMessages.length - 1]; if (lastMessage.sender !== 'ai') { alert("AI의 응답 후에만 제안을 요청할 수 있습니다."); isLoadingSuggestions = false; setLoadingState('suggestRepliesButton', '', false); return; } const scenarioTitleForPrompt = currentScenario.id === "custom" ? (currentCustomScenarioInput || "사용자 정의 주제") : currentScenario.title; const focusTopicForPrompt = currentScenario.id === "custom" ? "" : (currentFocusTopic ? `The user is also focusing on "${currentFocusTopic}".` : ''); const prompt = `Based on the AI Tutor's last message: "${lastMessage.text}", provide ONLY 3 diverse and natural-sounding replies (short to medium length) that the user (who is learning English) could say next in the "${scenarioTitleForPrompt}" scenario. ${focusTopicForPrompt} Format them strictly as a numbered list, starting each item with a number and a period (e.g., 1. Suggestion one.). Do not include any introductory or explanatory text before or after the list. Consider the current role of the user: ${userIsPlayingPrimaryRole ? 'they are the primary actor in the scenario (e.g., customer, patient)' : 'they are playing the AI tutor/staff role'}.`; const suggestionsText = await callGeminiAPI(prompt); let parsedSuggestions = suggestionsText.split('\n').map(s => s.trim()).filter(s => s.length > 0 && /^\d+\.\s*.+/.test(s)).map(s => s.replace(/^\d+\.\s*/, '').trim()).filter(s => s.length > 0 && !s.toLowerCase().startsWith("here are") && !s.toLowerCase().includes("suggestion for")); suggestedRepliesList.innerHTML = ''; if (parsedSuggestions.length > 0) { parsedSuggestions.slice(0,3).forEach(reply => { const li = document.createElement('li'); li.className = "text-xs sm:text-sm text-sky-700 hover:text-sky-800 cursor-pointer p-1.5 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"; li.textContent = `"${reply}"`; li.onclick = () => { userInputElem.value = reply; suggestedRepliesList.innerHTML = ''; suggestedRepliesContainer.classList.add('hidden'); }; suggestedRepliesList.appendChild(li); }); suggestedRepliesContainer.classList.remove('hidden'); suggestedRepliesContainer.classList.add('fade-in'); } else { suggestedRepliesList.innerHTML = `<li class="text-slate-500">적절한 제안을 찾지 못했어요.</li>`; suggestedRepliesContainer.classList.remove('hidden');} } catch (error) { suggestedRepliesList.innerHTML = `<li class="text-red-500">제안 생성 오류: ${error.message}</li>`; suggestedRepliesContainer.classList.remove('hidden'); } finally { isLoadingSuggestions = false; setLoadingState('suggestRepliesButton', '', false); } }
            async function handleAnalyzeSentenceLogic() { if (isLoadingAnalysis) return; const userMessages = currentMessages.filter(msg => msg.sender === 'user'); if (userMessages.length === 0) { alert("분석할 사용자 메시지가 없습니다."); return; } isLoadingAnalysis = true; setLoadingState('analyzeSentenceButton', '분석중...', true); suggestedRepliesList.innerHTML = ''; suggestedRepliesContainer.classList.add('hidden'); closeAnalysisModal(); try { const lastUserMessage = userMessages[userMessages.length - 1]; const scenarioTitleForPrompt = currentScenario.id === "custom" ? (currentCustomScenarioInput || "사용자 정의 주제") : currentScenario.title; const focusTopicForPrompt = currentScenario.id === "custom" ? "" : (currentFocusTopic ? `They are focusing on "${currentFocusTopic}".` : ''); const analysisPrompt = `The user (learning English) said: "${lastUserMessage.text}" in the context of "${scenarioTitleForPrompt}" scenario. ${focusTopicForPrompt} Provide a structured analysis in English: **⭐ Overall Impression:** (Brief positive comment or general feel) **👍 Strengths:** (What was good about the sentence) **💡 Areas for Improvement:** **Grammar:** (Specific errors & corrections. If none, say "Grammar is good.") **Vocabulary:** (Word choice suggestions, better alternatives. If good, say "Vocabulary is appropriate.") **Naturalness/Fluency:** (Tips to sound more natural. If good, say "Sounds natural.") **✨ Suggested Revision (if any):** (Offer a revised version of the sentence if significant improvements can be made) Keep feedback constructive and easy for an English learner. After the English analysis, provide a concise summary of the feedback in Korean, under a heading "🇰🇷 한국어 요약:". This summary should highlight the main points of the feedback for a beginner to understand easily.`; const combinedAnalysisText = await callGeminiAPI(analysisPrompt); const koreanSummaryMarker = "🇰🇷 한국어 요약:"; const koreanSummaryIndex = combinedAnalysisText.indexOf(koreanSummaryMarker); let engAnalysis = ""; let korSummary = "한국어 요약을 생성하지 못했습니다."; if (koreanSummaryIndex !== -1) { engAnalysis = combinedAnalysisText.substring(0, koreanSummaryIndex).trim(); korSummary = combinedAnalysisText.substring(koreanSummaryIndex + koreanSummaryMarker.length).trim(); } else { engAnalysis = combinedAnalysisText.trim(); } englishAnalysisResultDiv.innerHTML = simpleMarkdownToHtml(engAnalysis); koreanAnalysisResultDiv.innerHTML = simpleMarkdownToHtml(korSummary); analysisModal.classList.remove('hidden'); analysisModal.classList.add('fade-in'); } catch (error) { englishAnalysisResultDiv.textContent = `분석 오류: ${error.message}`; koreanAnalysisResultDiv.textContent = ""; analysisModal.classList.remove('hidden'); analysisModal.classList.add('fade-in'); } finally { isLoadingAnalysis = false; setLoadingState('analyzeSentenceButton', '', false); } }
            
            function handleRoleSwapClick() { 
                userIsPlayingPrimaryRole = !userIsPlayingPrimaryRole; 
                currentMessages = []; 
                renderMessages(); 
                userInputElem.value = ''; 
                updateScenarioDisplay(false); 
                const currentRoleDescription = userIsPlayingPrimaryRole ? 
                    (currentScenario.id === 'custom' ? '직접 입력한 상황의 주도적인 역할' : `"${currentScenario.title}" 상황의 주도적인 역할 (예: 손님, 환자)`) :
                    (currentScenario.id === 'custom' ? '직접 입력한 상황의 AI 역할' : `"${currentScenario.title}" 상황의 AI 역할 (예: 직원, 의사)`);
                
                alert(`역할이 변경되었습니다! 이제 당신은 "${currentRoleDescription}"입니다. AI가 먼저 말을 걸도록 하거나, 새로운 역할에 맞춰 대화를 시작해보세요.`);
                
                if (!userIsPlayingPrimaryRole && currentMessages.length === 0 && currentScenario.id !== 'custom') {
                    // 역할 변경 후 AI가 먼저 말하도록 유도하는 예시 (선택적)
                    // const aiGreeting = currentScenario.starters_userAsOther && currentScenario.starters_userAsOther.length > 0 ? currentScenario.starters_userAsOther[0] : "Hello! How can I assist you?";
                    // currentMessages.push({ sender: 'ai', text: aiGreeting, timestamp: new Date() });
                    // renderMessages();
                }
            }

            function closeAnalysisModal() {
                analysisModal.classList.add('hidden');
                englishAnalysisResultDiv.innerHTML = '';
                koreanAnalysisResultDiv.innerHTML = '';
            }

            function closeGuideModalAndSavePreference() {
                guideModal.classList.add('hidden');
                localStorage.setItem(`guideShown_${appId}`, 'true');
            }

            // --- 이벤트 리스너 설정 ---
            scenarioPickerButton.addEventListener('click', toggleScenarioPicker);
            newConversationButton.addEventListener('click', handleNewConversation);
            helpButton.addEventListener('click', () => { 
                guideModal.classList.remove('hidden');
                guideModal.classList.add('fade-in');
            });
            closeGuideModalButton.addEventListener('click', closeGuideModalAndSavePreference);
            confirmGuideModalButton.addEventListener('click', closeGuideModalAndSavePreference);

            sendMessageButton.addEventListener('click', handleSendMessage);
            userInputElem.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !isLoading) handleSendMessage(); });
            suggestRepliesButton.addEventListener('click', handleSuggestRepliesLogic);
            analyzeSentenceButton.addEventListener('click', handleAnalyzeSentenceLogic);
            roleSwapButton.addEventListener('click', handleRoleSwapClick);
            
            closeAnalysisModalButtonFromAnalysis.addEventListener('click', closeAnalysisModal);
            confirmAnalysisModalButtonFromAnalysis.addEventListener('click', closeAnalysisModal);
            
            focusTopicInput.addEventListener('change', (e) => { currentFocusTopic = e.target.value; });
            customScenarioInputElem.addEventListener('change', (e) => { currentCustomScenarioInput = e.target.value; updateScenarioDisplay(); });

            document.addEventListener('click', (event) => { 
                if (scenarioPickerButton && !scenarioPickerButton.contains(event.target) && scenarioDropdown && !scenarioDropdown.contains(event.target) && showScenarioPicker) {
                    toggleScenarioPicker();
                }
                if (analysisModalContent && !analysisModalContent.contains(event.target) && analysisModal && !analysisModal.classList.contains('hidden') && analyzeSentenceButton && !analyzeSentenceButton.contains(event.target)) {
                    if (suggestRepliesButton && !suggestRepliesButton.contains(event.target)) { 
                         closeAnalysisModal();
                    }
                }
                if (guideModalContent && !guideModalContent.contains(event.target) && guideModal && !guideModal.classList.contains('hidden') && helpButton && !helpButton.contains(event.target)) {
                    closeGuideModalAndSavePreference();
                }
            });

            // --- 초기화 ---
            initializeAppLogic();
        }); 
    </script>
</body>
</html>
